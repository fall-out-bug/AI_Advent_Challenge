# AI Advent Challenge

[English](README.md) | [Русский](README.ru.md)

> Ежедневные AI-проекты для изучения языковых моделей и мультиагентных систем

## Обзор

Этот репозиторий содержит ежедневные задачи по созданию AI-систем с языковыми моделями. Каждый день вводит новые концепции и основывается на предыдущих задачах.

**Обновления:** Мы публикуем новости и дайджесты в Telegram-канале [Высоконагруженный кабанчик](https://t.me/data_intensive_boar).

**Текущий статус:** ✅ Stage 06_04 (финальная верификация и передача) — CI-автоматизация для shared infra включена, плейбук мейнтейнеров опубликован, идёт закрепление sign-off.

**Статус проекта:**
- ✅ 18 ежедневных задач завершено
- ✅ Clean Architecture полностью реализована
- ✅ 420+ тестов с 80%+ покрытием
- ✅ Production-ready мультиагентная система с самосовершенствованием
- ✅ Автоматическая оценка качества и файнтюнинг
- ✅ Полная документация для AI-ассистентов

**Ключевые возможности:**
- ✅ 17 ежедневных задач от простого чата до самосовершенствующихся AI-систем
- ✅ Clean Architecture с принципами SOLID
- ✅ 420+ тестов с 80%+ покрытием
- ✅ Поддержка множества моделей (StarCoder, Mistral, Qwen, TinyLlama)
- ✅ Интеграция MCP (Model Context Protocol) с HTTP сервером
- ✅ MCP-aware агент с автоматическим обнаружением и выполнением инструментов
- ✅ Telegram бот с FSM-based диалогами для управления каналами и дайджестами
- ✅ **Гибридное распознавание намерений** (Правила + LLM с кешированием)
- ✅ **Интеграция HW Checker** (all_checks_status, queue_status, retry_check)
- ✅ **Ревью домашних работ через Telegram** (список домашних работ, ревью по commit hash)
- ✅ Дайджесты каналов с поддержкой метаданных (заголовок, описание)
- ✅ Генерация PDF-дайджестов с автоматическим сбором постов
- ✅ Централизованная система логирования со структурированным выводом
- ✅ Мониторинг работоспособности и метрики dashboard
- ✅ Hotreload для разработки (uvicorn --reload + watchdog)
- ✅ **Multi-Pass Code Review** (3-проходная архитектура для анализа домашних работ)
- ✅ **LLM-as-Judge оценка качества** (автоматическая оценка суммаризаций)
- ✅ **Stage 05 RU-бенчмарки** (качество дайджестов и ревью с релизной периодичностью)
- ✅ **Самосовершенствующаяся система** (автоматический файнтюнинг на качественных данных)
- ✅ **Асинхронная длинная суммаризация** (обработка через очередь с таймаутом 600s)
- ✅ **Pass 4 анализ логов** (LLM-группировка, классификация и поиск корневых причин)
- ✅ **Интеграция статического анализа** (Flake8, Pylint, MyPy, Black, isort в отчетах)
- ✅ **MCP-публикация первичного класса** (LLM вызывает инструмент HW Checker MCP с HTTP-фолбеком)
- ✅ **Генерация хайку** (поэтичный постскриптум к отчёту)
- ✅ **Интеграционные контракты** (OpenAPI, JSON Schema, cURL/Python примеры)

### Stage 05 · Бенчмарк (Dry Run)

```bash
poetry run python scripts/quality/benchmark/run_benchmark.py \
  --scenario channel_digest_ru \
  --dataset data/benchmarks/benchmark_digest_ru_v1/2025-11-09_samples.jsonl \
  --dry-run --fail-on-warn
```

Опция `--dry-run` использует сохранённые оценки судьи и подходит для CI/локальных
проверок без вызова LLM. Для полноценного прогона уберите флаг и заранее загрузите
переменные окружения доступа к общему LLM и Mongo.

## Быстрый старт

```bash
# Установить зависимости
make install

# Запустить тесты
make test

# Запустить API
make run-api

# Запустить CLI
make run-cli
```

Подробные инструкции по настройке см. в [DEVELOPMENT.md](docs/guides/en/DEVELOPMENT.md) и [Maintainer Playbook](docs/MAINTAINERS_GUIDE.md).

## Структура проекта

```
AI_Challenge/
├── src/              # Clean Architecture Core
│   ├── domain/      # Слой бизнес-логики
│   ├── application/ # Use cases и orchestrators
│   ├── infrastructure/ # Внешние интеграции
│   └── presentation/   # API и CLI
├── tasks/           # Архив ежедневных челленджей
├── archive/legacy/local_models/    # Архивная инфраструктура локальных моделей (устарела)
├── shared/          # Унифицированный SDK для взаимодействия с моделями
├── scripts/         # Утилитарные скрипты (infra, maintenance, quality)
├── config/          # Конфигурационные файлы
└── docs/            # Полная документация
```

## Ежедневные задачи

| День | Область фокуса | Ключевые технологии | Статус |
|------|----------------|---------------------|--------|
| День 1 | Базовый чат-интерфейс | Python, API | ✅ Завершено |
| День 2 | JSON-структурированные ответы | Python, JSON parsing | ✅ Завершено |
| День 3 | Режим советника | Python, Управление сессиями | ✅ Завершено |
| День 4 | Контроль температуры | Python, Экспериментирование | ✅ Завершено |
| День 5 | Локальные модели | SDK, Docker, FastAPI | ✅ Завершено |
| День 6 | Тестовый фреймворк | Тестирование, Генерация отчетов | ✅ Завершено |
| День 7 | Мультиагентные системы | FastAPI, Docker, Оркестрация | ✅ Завершено |
| День 8 | Анализ токенов | Clean Architecture, ML Engineering | ✅ Завершено |
| День 9 | Интеграция MCP | MCP Protocol, Управление контекстом | ✅ Завершено |
| День 10 | Production-Ready MCP | Оркестрация, стриминг, кеширование | ✅ Завершено |
| День 11 | Butler Bot FSM | Telegram Bot, FSM, Intent Parsing | ✅ Завершено |
| День 12 | Система PDF-дайджестов | MongoDB, PDF Generation, MCP Tools | ✅ Завершено |
| День 13 | Рефакторинг Butler Agent | Hybrid Intent Recognition, HW Checker, Metadata | ✅ Завершено |
| День 14 | Multi-Pass Code Review | MCP Homework Review, 3-проходный анализ | ✅ Завершено |
| День 15 | Оценка качества и файнтюнинг | LLM-as-Judge, Самосовершенствующаяся система, Hugging Face | ✅ Завершено |
| День 17 | Платформа code review и MCP-публикация | Очередь, статический анализ, лог-диагностика, MCP-инструменты | ✅ Завершено |
| День 18 | Перфоманс-бенчмарки | Prometheus, Benchmarking | ✅ Завершено |
| День 19 | Индексация документов (эмбеддинги) | Redis/FAISS, Mongo, LLM API | Запланировано |
| День 20 | Агент RAG vs Non‑RAG | Retrieval, LLM-as-Judge | Запланировано |

## Основная инфраструктура

### Локальные модели (архив)
- Локальные контейнеры с моделями заменены общей инфраструктурой.
- Наследные манифесты сохранены в `archive/legacy/local_models/`.

### Общий SDK
Унифицированный SDK для взаимодействия с моделями во всех задачах.

```python
from shared.clients.model_client import ModelClient
client = ModelClient(provider="perplexity")
response = await client.chat("Привет, мир!")
```

## Система проверки домашних работ

- **Пятиступенчатый конвейер**: Архитектура → Компоненты → Синтез → Статический анализ (Flake8, Pylint, MyPy, Black, isort) → Pass 4 анализ логов с рекомендациями от LLM.
- **Работа с архивами**: Импорт ZIP, семантический diff и сохранение сессий через `ReviewSubmissionUseCase`.
- **Диагностика рантайма**: Связка `LogParserImpl` + `LogNormalizer` формирует группы, которые анализируются `LLMLogAnalyzer` с порогами по уровню логов.
- **Творческий постскриптум**: Автоматическое хайку фиксирует тон ревью и ключевые риски.
- **Публикация результатов**: LLM вызывает внешний HW Checker MCP-инструмент (`submit_review_result`) через `MCPHTTPClient`; при сбоях используется HTTP-фолбек `ExternalAPIClient`.
- **Интеграционные активы**: Каталог `contracts/` (OpenAPI, JSON Schema, примеры) и подробные описания в `docs/day17/` и `docs/reference/en/review_system_architecture.md`.
- **Наблюдаемость**: Структурированные логи ревью, метрики Prometheus и аудиторский след в MongoDB.

## Docker Compose файлы

Основные конфигурации:

- **`docker-compose.butler.yml`** – продакшн-стек (MongoDB, MCP, воркеры, бот, Prometheus, Grafana).
- **`docker-compose.butler.dev.yml`** – дев-режим с хот-релоадом и упрощёнными настройками.

Легаси-манифесты (дни 11/12, full GPU-стек, MCP-демо) перенесены в `archive/docker-compose/`. Соответствующие `make`-таргеты продолжают работать и читают файлы из архива.

**Быстрый старт:**
```bash
# Запустить полный стек Butler / Day 17
make butler-up

# Остановить стек
make butler-down

# Запустить демо День 11 (через архивный compose)
make day-11-up
```

## Текущие возможности

**Самосовершенствующаяся LLM-система:**
- **LLM-as-Judge**: Автоматическая оценка качества с использованием Mistral (полнота, точность, связность, информативность)
- **Автоматический файнтюнинг**: Самосовершенствование путем обучения на качественных образцах (триггер при 100+ образцах)
- **Асинхронная оценка**: Паттерн fire-and-forget, не блокирует основной поток
- **Асинхронная длинная суммаризация**: Обработка больших дайджестов через очередь с таймаутом 600s, результат отправляется отдельным сообщением
- **Расширяемая архитектура**: Поддержка различных типов задач файнтюнинга (суммаризация, классификация, Q&A)
- **ML в Docker**: Полная интеграция Hugging Face Transformers в контейнерах
- **Управление датасетами**: Автоматический экспорт JSONL для файнтюнинга

**Система Butler Agent:**
- **Гибридное распознавание намерений**: Двухслойная архитектура (правила + LLM fallback) с кешированием
- **Интеграция HW Checker**: Полный мониторинг статуса, управление очередью и повторные попытки
- **Ревью домашних работ**: Список недавних коммитов и выполнение code review через Telegram бот
- **Платформа Multi-Pass Code Review**: Архитектура → Компоненты → Синтез → Статический анализ → Pass 4 лог-аналитика + хайку
- **MCP-публикация**: Вызов MCP-инструмента HW Checker напрямую из LLM с устойчивым HTTP-фолбеком
- **Пакет статического анализа**: Flake8, Pylint, MyPy, Black, isort включены в итоговый отчёт
- **Диагностика логов**: Группировка, классификация и рекомендации от LLM по боевым логам
- **Метаданные каналов**: Автоматическое получение заголовка и описания из Telegram API
- **Улучшенные дайджесты**: Адаптивная длина резюме на основе количества постов, временные промпты
- **Экранирование Markdown**: Безопасное форматирование сообщений для Telegram
- **Hotreload для разработки**: Быстрая итерация с автоматической перезагрузкой кода

**Система генерации PDF-дайджестов:**
- Генерация PDF-дайджестов через MCP инструменты (5 инструментов)
- Автоматический часовой сбор постов через `PostFetcherWorker`
- Гибридная дедупликация (message_id + content_hash)
- Кеширование PDF с TTL 1 час для мгновенной доставки
- Хранение в MongoDB с TTL 7 дней для автоматической очистки

**MCP-Aware Агент:**
- Автоматическое обнаружение инструментов через MCPToolsRegistry (кэш 5 минут)
- Выбор и выполнение инструментов на основе LLM
- Надежная логика повторных попыток с экспоненциальной задержкой
- Управление историей диалогов с автоматическим сжатием
- Интеграция метрик Prometheus

**Команды для ревью домашних работ:**
- `Покажи домашки` - Список недавних коммитов домашних работ со статусом
- `Сделай ревью {commit_hash}` - Скачать архив и выполнить code review
- Результаты ревью отправляются как Markdown файлы через Telegram

**День 17 – Платформа code review:**
- Встроенный статический анализ (Flake8, Pylint, MyPy, Black, isort) в каждом отчёте
- Pass 4 анализ логов с фильтрацией по уровню, группировкой и советами от LLM
- Публикация результатов через MCP tool call с автоматическим HTTP-фолбеком
- Интеграционные контракты (OpenAPI, JSON Schema, cURL/Python примеры) для внешних систем
- Markdown-отчёт с единым резюме, лог-диагностикой и хайку-постскриптумом

См. [docs/day12/USER_GUIDE.md](docs/day12/USER_GUIDE.md) для руководства пользователя и [docs/day12/api.md](docs/day12/api.md) для документации API.

## Поддержка AI-ассистентов

Этот репозиторий включает полную документацию для разработки с помощью AI:

- **[AI_CONTEXT.md](AI_CONTEXT.md)** - Полный контекст проекта для AI-ассистентов
- **[.cursorrules](.cursorrules)** - Стандарты и соглашения по кодированию
- **[docs/INDEX.md](docs/INDEX.md)** - Организованный индекс документации

Эти файлы помогают AI-кодинг ассистентам понять структуру проекта, паттерны и соглашения.

## Технологии

**Основные**: Python 3.10+, Poetry, Docker, FastAPI, Pydantic, pytest

**AI/ML**: HuggingFace Transformers, PyTorch, NVIDIA CUDA, 4-bit Quantization, Локальные модели, Файнтюнинг

**Архитектура**: Clean Architecture, Domain-Driven Design, SOLID принципы, LLM-as-Judge паттерн

**Инфраструктура**: Traefik, NVIDIA Container Toolkit, Multi-stage Docker builds, MongoDB, Prometheus

## Документация

Основная документация:
- [DEVELOPMENT.md](docs/guides/en/DEVELOPMENT.md) - Настройка, деплой и операции
- [ARCHITECTURE.md](docs/reference/en/ARCHITECTURE.md) - Архитектура системы
- [USER_GUIDE.md](docs/guides/en/USER_GUIDE.md) - Руководство пользователя
- [API_DOCUMENTATION.md](docs/reference/en/API_DOCUMENTATION.md) - Справочник по API
- [AGENT_INTEGRATION.ru.md](docs/guides/ru/AGENT_INTEGRATION.ru.md) - Руководство по интеграции MCP-aware агента
- [MONITORING.md](docs/reference/en/MONITORING.md) - Настройка мониторинга и Grafana дашборды
- [SECURITY.md](docs/reference/en/SECURITY.md) - Политики безопасности и практики

Документация День 15 (текущая):
- [Руководство по оценке качества и файнтюнингу](docs/day15/README.md)
- [API Документация](docs/day15/api.md)
- [Миграция с Дня 12](docs/day15/MIGRATION_FROM_DAY12.md)

Документация День 12:
- [Руководство пользователя PDF-дайджестов](docs/day12/USER_GUIDE.md)
- [API PDF-дайджестов](docs/day12/api.md)
- [Архитектура PDF-дайджестов](docs/day12/ARCHITECTURE.md)

См. [docs/INDEX.md](docs/INDEX.md) для полного индекса документации.

## Мониторинг

```bash
# Запустить стек мониторинга (Prometheus + Grafana)
docker-compose -f docker-compose.butler.yml up -d prometheus grafana

# Доступ к Grafana: http://localhost:3000 (admin/admin)
# Доступ к Prometheus: http://localhost:9090
```

Доступные дашборды:
1. **App Health** - Системные ресурсы, HTTP метрики, latency, доступность
2. **ML Service Metrics** - LLM inference latency, использование токенов, версионирование моделей
3. **Post Fetcher & PDF Metrics** - Метрики сбора постов и генерации PDF
4. **Quality Assessment Metrics** - Оценки качества, запуски файнтюнинга, рост датасета

См. [MONITORING.md](docs/reference/en/MONITORING.md) для подробной настройки.

## Как внести свой вклад

Мы приветствуем вклад! См. [CONTRIBUTING.md](CONTRIBUTING.md) для подробных инструкций.

**Основные правила:**
- Следовать PEP 8 и Дзену Python
- Функции максимум 15 строк где возможно
- 100% покрытие типов
- 80%+ покрытие тестами
- Документировать все изменения

## Лицензия

Этот проект лицензирован под MIT License - см. файл LICENSE для деталей.

---

**Примечание**: Это обучающий проект для изучения AI и языковых моделей. Используйте ответственно и в соответствии с применимыми условиями использования.
