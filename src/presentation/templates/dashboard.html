<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Challenge Metrics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 14px;
            text-transform: uppercase;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .card .label {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 5px;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status.healthy {
            background: #2ecc71;
            color: white;
        }

        .status.warning {
            background: #f39c12;
            color: white;
        }

        .status.error {
            background: #e74c3c;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            font-weight: 600;
            color: #34495e;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge.success {
            background: #d4edda;
            color: #155724;
        }

        .badge.error {
            background: #f8d7da;
            color: #721c24;
        }

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .metric-row:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ AI Challenge Metrics Dashboard</h1>

        <div id="dashboard">
            <div class="loading">Loading metrics...</div>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshData()">ðŸ”„ Refresh</button>

    <script>
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function formatPercent(num) {
            return (num * 100).toFixed(1) + '%';
        }

        function formatDuration(seconds) {
            if (seconds < 60) return seconds.toFixed(0) + 's';
            if (seconds < 3600) return (seconds / 60).toFixed(1) + 'm';
            return (seconds / 3600).toFixed(1) + 'h';
        }

        function getStatusClass(value, threshold) {
            if (value >= threshold * 0.9) return 'healthy';
            if (value >= threshold * 0.7) return 'warning';
            return 'error';
        }

        function buildDashboard(data) {
            const metrics = data.metrics;
            const recentOps = data.recent_operations || [];

            let html = `
                <div class="grid">
                    <div class="card">
                        <h2>Total Requests</h2>
                        <div class="value">${formatNumber(metrics.request_count)}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(metrics.request_count / 10000 * 100, 100)}%"></div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>Success Rate</h2>
                        <div class="value">${formatPercent(metrics.success_rate)}</div>
                        <span class="status ${getStatusClass(metrics.success_rate, 0.95)}">
                            ${metrics.success_rate >= 0.95 ? 'Healthy' : metrics.success_rate >= 0.8 ? 'Warning' : 'Critical'}
                        </span>
                    </div>

                    <div class="card">
                        <h2>Total Tokens</h2>
                        <div class="value">${formatNumber(metrics.total_tokens_used)}</div>
                        <div class="label">Used across all operations</div>
                    </div>

                    <div class="card">
                        <h2>Avg Response Time</h2>
                        <div class="value">${metrics.average_response_time_ms.toFixed(0)}ms</div>
                        <div class="label">Mean response time</div>
                    </div>

                    <div class="card">
                        <h2>Uptime</h2>
                        <div class="value">${formatDuration(metrics.uptime_seconds)}</div>
                        <div class="label">Since last restart</div>
                    </div>

                    <div class="card">
                        <h2>Error Count</h2>
                        <div class="value">${formatNumber(metrics.failed_requests)}</div>
                        <div class="label">Failed requests</div>
                    </div>
                </div>
            `;

            // Add percentiles if available
            if (metrics.response_time_percentiles) {
                const percentiles = metrics.response_time_percentiles;
                html += `
                    <div class="card">
                        <h2>Response Time Percentiles</h2>
                        <div class="chart-container">
                            <div class="metric-row">
                                <span>P50 (median)</span>
                                <strong>${percentiles.p50.toFixed(0)}ms</strong>
                            </div>
                            <div class="metric-row">
                                <span>P95</span>
                                <strong>${percentiles.p95.toFixed(0)}ms</strong>
                            </div>
                            <div class="metric-row">
                                <span>P99</span>
                                <strong>${percentiles.p99.toFixed(0)}ms</strong>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Add token usage by operation
            if (metrics.token_usage_by_operation && Object.keys(metrics.token_usage_by_operation).length > 0) {
                html += `
                    <div class="card">
                        <h2>Token Usage by Operation</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Operation</th>
                                    <th>Tokens</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                for (const [op, tokens] of Object.entries(metrics.token_usage_by_operation)) {
                    html += `
                        <tr>
                            <td>${op}</td>
                            <td>${formatNumber(tokens)}</td>
                        </tr>
                    `;
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Add recent operations
            if (recentOps.length > 0) {
                html += `
                    <div class="card">
                        <h2>Recent Operations (Last 20)</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Operation</th>
                                    <th>Response Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                for (const op of recentOps.slice(-20)) {
                    const time = new Date(op.timestamp).toLocaleTimeString();
                    html += `
                        <tr>
                            <td>${time}</td>
                            <td>${op.operation}</td>
                            <td>${op.response_time_ms.toFixed(0)}ms</td>
                            <td><span class="badge ${op.success ? 'success' : 'error'}">${op.success ? 'Success' : 'Error'}</span></td>
                        </tr>
                    `;
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            return html;
        }

        async function loadData() {
            try {
                const response = await fetch('/dashboard/data');
                const data = await response.json();
                document.getElementById('dashboard').innerHTML = buildDashboard(data);
            } catch (error) {
                document.getElementById('dashboard').innerHTML = `
                    <div class="card">
                        <h2 style="color: #e74c3c;">Error Loading Data</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function refreshData() {
            document.getElementById('dashboard').innerHTML = '<div class="loading">Refreshing...</div>';
            loadData();
        }

        // Load data on page load
        loadData();

        // Auto-refresh every 5 seconds
        setInterval(loadData, 5000);
    </script>
</body>
</html>
