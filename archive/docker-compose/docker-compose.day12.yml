services:
  mistral-chat:
    build:
      context: ./local_models
      dockerfile: Dockerfile
    image: ai-challenge-mistral:day12
    container_name: mistral-chat-day12
    ports:
      - "8001:8000"
    env_file:
      - .env
    environment:
      - MODEL_NAME=mistralai/Mistral-7B-Instruct-v0.3
      - HF_TOKEN=${HF_TOKEN}
      - MAX_INPUT_TOKENS=4096
      - MAX_OUTPUT_TOKENS=2048
    volumes:
      - ./cache/models:/home/appuser/.cache/huggingface/hub:rw
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    networks:
      - butler-network
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 16G
        reservations:
          cpus: '2.0'
          memory: 8G
    runtime: nvidia  # Optional: remove if no GPU available

  mongodb:
    image: mongo:6.0
    container_name: butler-mongodb-day12
    ports:
      - "27017:27017"
    volumes:
      - /datam/mongodb:/data/db
    # Note: MongoDB warnings about access control and transparent_hugepage are expected
    # in development. For production, enable authentication and configure system settings.
    environment:
      - MONGO_INITDB_DATABASE=butler
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ ping: 1 }).ok" , "localhost:27017/butler"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - butler-network

  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    image: ai-challenge-mcp:day12
    container_name: mcp-server-day12
    env_file:
      - .env
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - DB_NAME=butler
      - LLM_URL=http://mistral-chat:8000
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
      # Agent parsing and pipeline
      - AGENT_DECISION_TEMPERATURE=${AGENT_DECISION_TEMPERATURE:-0.2}
      - AGENT_DECISION_MAX_TOKENS=${AGENT_DECISION_MAX_TOKENS:-256}
      - AGENT_FORMATTING_TEMPERATURE=${AGENT_FORMATTING_TEMPERATURE:-0.7}
      - AGENT_FORMATTING_MAX_TOKENS=${AGENT_FORMATTING_MAX_TOKENS:-1024}
      - PARSER_STRICT_MODE=${PARSER_STRICT_MODE:-false}
      - PARSER_MAX_ATTEMPTS=${PARSER_MAX_ATTEMPTS:-3}
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_SESSION_STRING=${TELEGRAM_SESSION_STRING}
      # Evaluation and fine-tuning settings
      - ENABLE_QUALITY_EVALUATION=${ENABLE_QUALITY_EVALUATION:-true}
      - EVALUATION_MIN_SCORE_FOR_DATASET=${EVALUATION_MIN_SCORE_FOR_DATASET:-0.7}
      - ENABLE_AUTO_FINETUNING=${ENABLE_AUTO_FINETUNING:-true}
      - FINETUNING_MIN_SAMPLES=${FINETUNING_MIN_SAMPLES:-100}
      - FINETUNING_MODEL_OUTPUT_DIR=/models/fine_tuned
      - FINETUNING_BASE_MODEL=${FINETUNING_BASE_MODEL:-mistralai/Mistral-7B-Instruct-v0.2}
      - FINETUNING_NUM_EPOCHS=${FINETUNING_NUM_EPOCHS:-3}
      - FINETUNING_BATCH_SIZE=${FINETUNING_BATCH_SIZE:-4}
      - FINETUNING_LEARNING_RATE=${FINETUNING_LEARNING_RATE:-2e-5}
    ports:
      - "8004:8004"
    volumes:
      # Mount Pyrogram session directory (created by init_pyrogram.py)
      - ./sessions:/app/sessions:rw
      # Mount models directory for fine-tuned models
      - ./models:/models/fine_tuned:rw
      # Mount data directory for datasets
      - ./data:/app/data:rw
    depends_on:
      mongodb:
        condition: service_healthy
      mistral-chat:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - butler-network

  telegram-bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    image: ai-challenge-bot:day12
    container_name: telegram-bot-day12
    env_file:
      - .env
    environment:
      # Required: Telegram bot token from @BotFather
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - MCP_SERVER_URL=http://mcp-server:8004
      - LLM_URL=http://mistral-chat:8000
      - MISTRAL_URL=http://mistral-chat:8000
      - MONGODB_URL=mongodb://mongodb:27017
      - DB_NAME=butler
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
      # Agent parsing and pipeline
      - AGENT_DECISION_TEMPERATURE=${AGENT_DECISION_TEMPERATURE:-0.2}
      - AGENT_DECISION_MAX_TOKENS=${AGENT_DECISION_MAX_TOKENS:-256}
      - AGENT_FORMATTING_TEMPERATURE=${AGENT_FORMATTING_TEMPERATURE:-0.7}
      - AGENT_FORMATTING_MAX_TOKENS=${AGENT_FORMATTING_MAX_TOKENS:-1024}
      - PARSER_STRICT_MODE=${PARSER_STRICT_MODE:-false}
      - PARSER_MAX_ATTEMPTS=${PARSER_MAX_ATTEMPTS:-3}
    depends_on:
      mongodb:
        condition: service_healthy
      mcp-server:
        condition: service_healthy
      mistral-chat:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - butler-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M

  summary-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    image: ai-challenge-worker:day12
    container_name: summary-worker-day12
    env_file:
      - .env
    environment:
      # Required: Telegram bot token from @BotFather (same as bot)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - MCP_SERVER_URL=http://mcp-server:8004
      - LLM_URL=http://mistral-chat:8000
      - MONGODB_URL=mongodb://mongodb:27017
      - DB_NAME=butler
      - MORNING_SUMMARY_TIME=${MORNING_SUMMARY_TIME:-09:00}
      - EVENING_DIGEST_TIME=${EVENING_DIGEST_TIME:-20:00}
      - QUIET_HOURS_START=${QUIET_HOURS_START:-22}
      - QUIET_HOURS_END=${QUIET_HOURS_END:-8}
      - DEBUG_NOTIFICATION_INTERVAL_MINUTES=${DEBUG_NOTIFICATION_INTERVAL_MINUTES:-0}
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    depends_on:
      mongodb:
        condition: service_healthy
      mcp-server:
        condition: service_healthy
      mistral-chat:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - butler-network
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          memory: 64M

  post-fetcher-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    image: ai-challenge-worker:day12
    container_name: post-fetcher-worker-day12
    command: ["python", "-m", "src.workers.post_fetcher_worker_main"]
    env_file:
      - .env
    environment:
      - MCP_SERVER_URL=http://mcp-server:8004
      - MONGODB_URL=mongodb://mongodb:27017
      - DB_NAME=butler
      - POST_FETCH_INTERVAL_HOURS=${POST_FETCH_INTERVAL_HOURS:-1}
      - POST_TTL_DAYS=${POST_TTL_DAYS:-7}
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    depends_on:
      mongodb:
        condition: service_healthy
      mcp-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - butler-network
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          memory: 64M

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus-day12
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    restart: unless-stopped
    networks:
      - butler-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M

  grafana:
    image: grafana/grafana:latest
    container_name: grafana-day12
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - butler-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M

volumes:
  mongodb_data_day12:
  prometheus_data:
  grafana_data:

networks:
  butler-network:
    driver: bridge

