# Механизм поиска каналов

## Как работает поиск каналов

### Текущая реализация

Поиск каналов работает в два этапа:

#### 1. Поиск в dialogs пользователя (`search_channels_by_name`)

**Где ищет:**
- В списке dialogs пользователя (каналы, которые пользователь видел/к которым имел доступ)
- Использует `client.get_dialogs()` из Pyrogram

**Как ищет:**
- Сравнивает query с `title` и `username` каналов
- Поддерживает частичное совпадение (case-insensitive)
- Проверяет, что канал имеет и `username`, и `title` (публичный канал)

**Ограничения:**
- ❌ Не находит каналы, которых нет в dialogs пользователя
- ❌ Не работает для каналов, которые пользователь никогда не видел
- ✅ Работает для каналов, на которые пользователь подписан или к которым имел доступ

**Пример:**
```
Запрос: "крупнокалиберный переполох"
→ Ищет в dialogs по title "Крупнокалиберный Переполох"
→ Если канал есть в dialogs → найдет
→ Если канала нет в dialogs → не найдет
```

#### 2. Fallback: Direct resolve (если поиск в dialogs не дал результата)

**Где ищет:**
- Прямое обращение к Telegram API через `client.get_chat(username)`

**Как ищет:**
- Пытается разрешить query как username
- Убирает `@` если есть
- Вызывает `get_chat(username_to_try)`

**Ограничения:**
- ❌ Работает только если query это username (например, "bolshiepushki")
- ❌ Не работает если query это название (например, "крупнокалиберный переполох")
- ✅ Работает для публичных каналов по username

**Пример:**
```
Запрос: "bolshiepushki"
→ Пытается resolve "bolshiepushki" как username
→ Если канал публичный → найдет
→ Если канал приватный → не найдет
```

### Проблема с "крупнокалиберный переполох"

**Сценарий:**
1. Пользователь вводит: "крупнокалиберный переполох" (название канала)
2. Username канала: `bolshiepushki`
3. Канал не в dialogs пользователя (пользователь не подписан, не видел)

**Что происходит:**
1. ✅ Поиск в dialogs → не находит (канала нет в dialogs)
2. ❌ Direct resolve → не работает (query это не username)
3. ❌ Результат: канал не найден

**Решение:**
Для поиска по названию каналов, которых нет в dialogs, нужен глобальный поиск через Telegram API. Однако:
- Telegram Bot API не поддерживает глобальный поиск каналов
- Pyrogram MTProto API имеет ограниченный `search_global`, который может не работать для всех каналов
- Telegram не предоставляет публичный API для поиска каналов по названию

### Что можно сделать

#### Вариант 1: Использовать `SearchChannelForSubscriptionUseCase` с LLM

Текущий механизм уже использует `ChannelScorer` для ранжирования результатов из dialogs. Но это не решает проблему, если канала нет в dialogs.

#### Вариант 2: Попросить пользователя ввести username

Если канал не найден в dialogs, можно попросить пользователя ввести username напрямую.

#### Вариант 3: Использовать Telegram Web или другие методы

Telegram Web использует другой API для поиска, но это требует дополнительной интеграции.

### Текущий workflow

```
1. Пользователь: "Подпишись на крупнокалиберный переполох"
   ↓
2. SearchChannelForSubscriptionUseCase
   ↓
3. search_channels_by_name("крупнокалиберный переполох")
   ↓
4. Поиск в dialogs → не находит
   ↓
5. Direct resolve → не работает (query это не username)
   ↓
6. Результат: канал не найден → показываем ошибку
```

### Рекомендации

Для улучшения поиска:

1. **Добавить подсказку пользователю:**
   - Если канал не найден, предложить ввести username
   - Показать примеры: "Попробуйте ввести @bolshiepushki"

2. **Использовать LLM для извлечения username из названия:**
   - Если есть база известных каналов, LLM может сопоставить название с username
   - Но это требует предварительной базы данных каналов

3. **Использовать ChannelScorer для ранжирования:**
   - Если канал есть в dialogs, но название не точное совпадение
   - ChannelScorer найдет его через fuzzy matching

## Текущие улучшения

✅ Добавлен fallback на direct resolve для username
✅ Добавлена фильтрация результатов без username/title
✅ Улучшен token overlap matching для склонений (например, "Гладкову" → "Гладков")
✅ Добавлена валидация на всех уровнях

## Ограничения API Telegram

Telegram не предоставляет публичный API для:
- Глобального поиска каналов по названию
- Поиска каналов, которых нет в dialogs пользователя
- Поиска приватных каналов

Поэтому поиск работает только для:
- Каналов в dialogs пользователя
- Публичных каналов по username (через direct resolve)
