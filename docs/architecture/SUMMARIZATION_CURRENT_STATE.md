# –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 2025-11-04  
**–¶–µ–ª—å:** –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∑–∞–¥–∞—á–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
3. [–î–≤–∞ —Ç–∏–ø–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏](#–¥–≤–∞-—Ç–∏–ø–∞-—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏)
4. [–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#–¥–µ—Ç–∞–ª—å–Ω–∞—è-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
5. [–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö)
6. [Map-Reduce –∞–ª–≥–æ—Ä–∏—Ç–º](#map-reduce-–∞–ª–≥–æ—Ä–∏—Ç–º)
7. [–û—á–∏—Å—Ç–∫–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#–æ—á–∏—Å—Ç–∫–∞-–∏-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
8. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-–∏-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
9. [–ü—Ä–æ–±–ª–µ–º—ã –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥](#–ø—Ä–æ–±–ª–µ–º—ã-–∏-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π-–¥–æ–ª–≥)
10. [–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏](#–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏-–º–µ–∂–¥—É-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏)

---

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ —Ä–µ—à–∞–µ—Ç **–¥–≤–µ —Ä–∞–∑–Ω—ã–µ –∑–∞–¥–∞—á–∏**:

1. **–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (Task Summary) - —É—Ç—Ä–µ–Ω–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å overview –∑–∞–¥–∞—á
2. **–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ –∏–∑ Telegram-–∫–∞–Ω–∞–ª–æ–≤** (Channel Digest) - –≤–µ—á–µ—Ä–Ω–∏–µ –¥–∞–π–¥–∂–µ—Å—Ç—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞

–û–±–µ –∑–∞–¥–∞—á–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–æ–±—â—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É LLM-—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏**, –Ω–æ –∏–º–µ—é—Ç —Ä–∞–∑–Ω—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Ñ–æ—Ä–º–∞—Ç—ã –≤—ã–≤–æ–¥–∞.

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Clean Architecture)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PRESENTATION LAYER                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ MCP Tools        ‚îÇ  ‚îÇ Telegram Bot   ‚îÇ  ‚îÇ Workers      ‚îÇ‚îÇ
‚îÇ  ‚îÇ - reminder_tools ‚îÇ  ‚îÇ (handlers)     ‚îÇ  ‚îÇ - summary_   ‚îÇ‚îÇ
‚îÇ  ‚îÇ - channel_digest ‚îÇ  ‚îÇ                ‚îÇ  ‚îÇ   worker     ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   APPLICATION LAYER                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  ‚îÇ Data Fetchers    ‚îÇ  ‚îÇ Formatters     ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ - get_summary_   ‚îÇ  ‚îÇ - format_      ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ   text           ‚îÇ  ‚îÇ   summary      ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ - get_digest_    ‚îÇ  ‚îÇ - format_      ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ   texts          ‚îÇ  ‚îÇ   digest       ‚îÇ                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 INFRASTRUCTURE LAYER                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ LLM Summarization Core                               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - summarizer.py (summarize_posts)                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - MapReduceSummarizer                              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - SemanticChunker                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - TokenCounter                                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Prompts (get_map_prompt, get_reduce_prompt)     ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ LLM Clients                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - LLMClient (abstract)                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - ResilientLLMClient (auto-fallback)               ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Repositories                                         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - TaskRepository                                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - PostRepository                                   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      DOMAIN LAYER                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  ‚îÇ Value Objects    ‚îÇ  ‚îÇ Entities       ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ - TaskSummary    ‚îÇ  ‚îÇ - Task         ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ - DigestItem     ‚îÇ  ‚îÇ - Post         ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ - DigestMessage  ‚îÇ  ‚îÇ                ‚îÇ                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 1. Domain Layer (–ß–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)

**–§–∞–π–ª—ã:**
- `src/domain/value_objects/task_summary.py`
- `src/domain/entities/task.py`

**Value Objects:**

```python
class TaskSummary(BaseModel):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞—á–∞–º"""
    total: int
    completed: int
    overdue: int
    high_priority: int
    timeframe: Optional[str]

class DigestItem(BaseModel):
    """–î–∞–π–¥–∂–µ—Å—Ç –æ–¥–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞"""
    channel: str
    summary: str
    post_count: int
    tags: List[str]

class DigestMessage(BaseModel):
    """–ü–æ–ª–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤"""
    items: List[DigestItem]
    generated_at_iso: Optional[str]
```

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ß–∏—Å—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç–∏–ø–æ–≤.

---

### 2. Infrastructure Layer (–í–Ω–µ—à–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

#### 2.1 LLM Summarization Core

**–§–∞–π–ª:** `src/infrastructure/llm/summarizer.py`

**–û—Å–Ω–æ–≤–Ω–æ–π API:**

```python
async def summarize_posts(
    posts: List[dict],
    max_sentences: int = None,
    llm: LLMClient | None = None,
    time_period_hours: int = None
) -> str:
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏.
    
    –õ–æ–≥–∏–∫–∞:
    1. –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å—Ç–æ–≤ (_clean_text_for_summary)
    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤
    3. –ï—Å–ª–∏ > 3000 —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí Map-Reduce
    4. –ï—Å–ª–∏ <= 3000 ‚Üí –ø—Ä—è–º–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
    5. Fallback –Ω–∞ bullet list –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
    """
```

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:**

1. **–û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞:**
   - –£–¥–∞–ª–µ–Ω–∏–µ URL
   - –£–¥–∞–ª–µ–Ω–∏–µ UTM –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–µ–ª–æ–≤
   - –£–¥–∞–ª–µ–Ω–∏–µ "—á–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ"
   - –û–±—Ä–µ–∑–∫–∞ –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –ø–æ—Å—Ç

2. **–í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
   - `TokenCounter.count_tokens()` ‚Üí –ø–æ–¥—Å—á—ë—Ç —Ç–æ–∫–µ–Ω–æ–≤
   - –ï—Å–ª–∏ **> 3000 —Ç–æ–∫–µ–Ω–æ–≤** ‚Üí `MapReduceSummarizer`
   - –ï—Å–ª–∏ **<= 3000 —Ç–æ–∫–µ–Ω–æ–≤** ‚Üí –ø—Ä—è–º–æ–π –ø—Ä–æ–º–ø—Ç –∫ LLM

3. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞:**
   - –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - –Ø–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: "NO JSON, NO Markdown"
   - –í—Ä–µ–º–µ–Ω–Ω–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (24 —á–∞—Å–∞ / 7 –¥–Ω–µ–π)
   - –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

4. **Retry –ª–æ–≥–∏–∫–∞:**
   - 2 –ø–æ–ø—ã—Ç–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
   - –ù–∞ –æ—à–∏–±–∫–µ ‚Üí fallback –∫ bullet list

5. **–û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
   - –£–¥–∞–ª–µ–Ω–∏–µ JSON –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (`_clean_json_from_summary`)
   - –£–¥–∞–ª–µ–Ω–∏–µ Markdown —Å–∏–º–≤–æ–ª–æ–≤
   - –£–¥–∞–ª–µ–Ω–∏–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (>60% overlap)
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ `max_sentences`

**–ö–ª–∞—Å—Å MapReduceSummarizer:**

```python
class MapReduceSummarizer:
    """Map-Reduce –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤"""
    
    def __init__(
        self,
        llm: LLMClient,
        token_counter: TokenCounter,
        chunker: SemanticChunker,
        language: str = "ru"
    ):
        self.llm = llm
        self.token_counter = token_counter
        self.chunker = chunker
        self.language = language
    
    async def summarize_text(
        self,
        text: str,
        max_sentences: int = 8,
        temperature: float = 0.2,
        map_max_tokens: int = 600,
        reduce_max_tokens: int = 2000
    ) -> str:
        """
        Map phase: —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ chunk ‚Üí summaries[]
        Reduce phase: –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ summaries ‚Üí final_summary
        """
```

#### 2.2 Chunking & Token Counting

**–§–∞–π–ª—ã:**
- `src/infrastructure/llm/chunker.py`
- `src/infrastructure/llm/token_counter.py`

**SemanticChunker:**

```python
class SemanticChunker:
    """–†–∞–∑–±–∏–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ chunks —Å overlap"""
    
    def __init__(
        self,
        token_counter: TokenCounter,
        max_tokens: int = 3000,
        overlap_tokens: int = 200
    ):
        # –†–∞–∑–±–∏–≤–∞–µ—Ç –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (regex)
        # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç overlap –º–µ–∂–¥—É chunks –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. Regex split –ø–æ `.!?‚Ä¶` + –∑–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞
2. –ü–æ–¥—Å—á—ë—Ç —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
3. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ chunks ‚â§ max_tokens
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ overlap_tokens –≤ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ chunk

#### 2.3 Prompts

**–§–∞–π–ª:** `src/infrastructure/llm/prompts.py`

**–§—É–Ω–∫—Ü–∏–∏:**

```python
def get_map_prompt(text: str, language: str, max_sentences: int) -> str:
    """–ü—Ä–æ–º–ø—Ç –¥–ª—è Map —Ñ–∞–∑—ã (chunk ‚Üí key facts)"""
    # –†—É—Å—Å–∫–∏–π: "–í—ã–¥–µ–ª–∏ N –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –∏–∑ —ç—Ç–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞"
    # –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: "Summarize in N sentences"

def get_reduce_prompt(summaries: str, language: str, max_sentences: int) -> str:
    """–ü—Ä–æ–º–ø—Ç –¥–ª—è Reduce —Ñ–∞–∑—ã (summaries ‚Üí final)"""
    # –†—É—Å—Å–∫–∏–π: "–û–±—ä–µ–¥–∏–Ω–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ N –∏—Ç–æ–≥–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–º–ø—Ç–æ–≤:**
- ‚ùå NO JSON, NO Markdown
- ‚úÖ Plain text only
- ‚úÖ –Ø–≤–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —è–∑—ã–∫—É (ru/en)
- ‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Ñ–∞–∫—Ç–æ–≤
- ‚úÖ –Ø–≤–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

#### 2.4 Repositories

**–§–∞–π–ª—ã:**
- `src/infrastructure/repositories/task_repository.py`
- `src/infrastructure/repositories/post_repository.py`

**TaskRepository:**
- `list_tasks(user_id, status, limit)` ‚Üí –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `create_task(TaskIn)` ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `update_task(task_id, updates)` ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- `delete_task(task_id)` ‚Üí —É–¥–∞–ª–µ–Ω–∏–µ

**PostRepository:**
- `get_posts_by_user_subscriptions(user_id, hours)` ‚Üí –ø–æ—Å—Ç—ã –∏–∑ –ø–æ–¥–ø–∏—Å–æ–∫
- `save_post(post)` ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (datetime range)

---

### 3. Application Layer (–û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è)

#### 3.1 Data Fetchers

**–§–∞–π–ª:** `src/workers/data_fetchers.py`

**–§—É–Ω–∫—Ü–∏–∏:**

```python
async def get_summary_text(
    mcp_client: MCPClientProtocol,
    user_id: int,
    timeframe: str = "today",
    debug: bool = False
) -> Optional[str]:
    """
    –ü–æ–ª—É—á–∏—Ç—å summary –∑–∞–¥–∞—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –õ–æ–≥–∏–∫–∞:
    - –ï—Å–ª–∏ debug=True ‚Üí –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –≤ MongoDB
    - –ò–Ω–∞—á–µ ‚Üí –≤—ã–∑–æ–≤ MCP tool "get_summary"
    - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ format_summary()
    """

async def get_digest_texts(
    mcp_client: MCPClientProtocol,
    user_id: int,
    debug: bool = False
) -> list[str]:
    """
    –ü–æ–ª—É—á–∏—Ç—å digest —Ç–µ–∫—Å—Ç–æ–≤ –∏–∑ –∫–∞–Ω–∞–ª–æ–≤.
    
    –õ–æ–≥–∏–∫–∞:
    - –í—ã–∑–æ–≤ MCP tool "get_channel_digest"
    - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ format_single_digest()
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ (–ø–æ –æ–¥–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É –Ω–∞ –∫–∞–Ω–∞–ª)
    """
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –°–º–µ—à–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (–¥–∞–Ω–Ω—ã–µ + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ DB –≤ debug —Ä–µ–∂–∏–º–µ
- –ù–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –Ω–∞–¥ MCP client

#### 3.2 Formatters

**–§–∞–π–ª:** `src/workers/formatters.py`

**–§—É–Ω–∫—Ü–∏–∏:**

```python
def format_summary(
    tasks: list[dict],
    stats: dict,
    debug: bool = False
) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ task summary –¥–ª—è Telegram.
    
    –§–æ—Ä–º–∞—Ç:
    üåÖ Good morning! (–∏–ª–∏ üîç Debug Summary)
    üìä Tasks: N
    üî¥ High priority: M
    
    üî¥ Task 1
    üü° Task 2
    ...
    """

def format_single_digest(
    digest: dict,
    debug: bool = False
) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ channel digest.
    
    –§–æ—Ä–º–∞—Ç:
    üì∞ –î–∞–π–¥–∂–µ—Å—Ç –∫–∞–Ω–∞–ª–∞
    üìå @channel_name
    üìä –ü–æ—Å—Ç–æ–≤: N
    –¢–µ–≥–∏: #tag1, #tag2
    
    Summary text...
    """

def clean_markdown(text: str) -> str:
    """
    –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Markdown.
    
    –£–¥–∞–ª—è–µ—Ç:
    - * _ ` [ ] ( ) \
    - Escaped —Å–∏–º–≤–æ–ª—ã
    - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    """
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –û—á–∏—Å—Ç–∫–∞ Markdown –≤ formatters (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ infrastructure)
- –ñ—ë—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ emoji –∏ —Ñ–æ—Ä–º–∞—Ç—ã
- –ù–µ—Ç –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏

#### 3.3 Summary Helpers

**–§–∞–π–ª:** `src/presentation/mcp/tools/_summary_helpers.py`

**–§—É–Ω–∫—Ü–∏–∏:**

```python
def _build_summary_query(
    user_id: int,
    timeframe: str,
    now: datetime
) -> Dict[str, Any]:
    """
    –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ MongoDB query –¥–ª—è –∑–∞–¥–∞—á.
    
    Timeframes:
    - "today" ‚Üí deadline [start_of_day, end_of_day)
    - "tomorrow" ‚Üí deadline [tomorrow_start, tomorrow_end)
    - "week" ‚Üí deadline [today, +7 days)
    - "last_24h" ‚Üí empty query (filter in memory)
    - "last_7d" ‚Üí deadline [now-7d, now)
    """

def _compute_task_stats(
    tasks: list[dict],
    now_iso: str
) -> Dict[str, int]:
    """
    –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∑–∞–¥–∞—á–∞–º.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    - total: len(tasks)
    - completed: count(completed=True)
    - overdue: count(deadline < now AND completed=False)
    - high_priority: count(priority="high")
    """
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –õ–æ–≥–∏–∫–∞ –≤ `_summary_helpers.py` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ use case
- –†–∞—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö

---

### 4. Presentation Layer (API & Workers)

#### 4.1 MCP Tools

**–§–∞–π–ª:** `src/presentation/mcp/tools/reminder_tools.py`

```python
@mcp.tool()
async def get_summary(
    user_id: int,
    timeframe: str = "today"
) -> Dict[str, Any]:
    """
    MCP tool –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è summary –∑–∞–¥–∞—á.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    {
        "tasks": [...],
        "stats": {
            "total": N,
            "completed": M,
            "overdue": K,
            "high_priority": P
        }
    }
    """
```

**–§–∞–π–ª:** `src/presentation/mcp/tools/channels/channel_digest.py`

```python
@mcp.tool()
async def get_channel_digest(
    user_id: int,
    hours: int = 24
) -> Dict[str, Any]:
    """
    MCP tool –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è digest –∫–∞–Ω–∞–ª–æ–≤.
    
    –õ–æ–≥–∏–∫–∞:
    1. –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    2. –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —á–∞—Å–æ–≤
    3. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º
    4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞:
       - _normalize_post_dates()
       - _generate_summary() ‚Üí –≤—ã–∑–æ–≤ summarize_posts()
    5. –í–æ–∑–≤—Ä–∞—Ç {"digests": [...]}
    """

@mcp.tool()
async def get_channel_digest_by_name(
    user_id: int,
    channel_username: str,
    hours: int = 72
) -> Dict[str, Any]:
    """
    Digest –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞.
    
    –õ–æ–≥–∏–∫–∞:
    - –ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–∞ (case-insensitive, partial match, metadata)
    - Auto-subscribe –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    - –ü–æ–ø—ã—Ç–∫–∞ collect_posts –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    - Adaptive max_sentences (8-15 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Å—Ç–æ–≤)
    - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è summary
    """
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- `_generate_summary()` –∏ `_normalize_post_dates()` –≤ presentation —Å–ª–æ–µ
- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ domain/application)
- –ü—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã `summarize_posts()` –∏–∑ presentation

#### 4.2 Summary Worker

**–§–∞–π–ª:** `src/workers/summary_worker.py`

```python
class SummaryWorker:
    """Background worker –¥–ª—è scheduled —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    
    def __init__(
        self,
        bot_token: str,
        mcp_url: Optional[str] = None
    ):
        self.bot = Bot(token=bot_token)
        self.mcp = get_mcp_client(server_url=mcp_url)
        self.settings = get_settings()
    
    async def run(self) -> None:
        """
        Main loop:
        1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
        2. –ü—Ä–æ–≤–µ—Ä–∫–∞ quiet hours
        3. –û—Ç–ø—Ä–∞–≤–∫–∞ morning summary (morning_summary_time)
        4. –û—Ç–ø—Ä–∞–≤–∫–∞ evening digest (evening_digest_time)
        5. Debug mode: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–∂–¥—ã–µ N –º–∏–Ω—É—Ç
        """
    
    async def _send_morning_summary(self) -> None:
        """–£—Ç—Ä–µ–Ω–Ω–∏–π summary –∑–∞–¥–∞—á –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        # get_summary_text() ‚Üí send_with_retry()
    
    async def _send_evening_digest(self) -> None:
        """–í–µ—á–µ—Ä–Ω–∏–π digest –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        # get_digest_texts() ‚Üí send_with_retry() for each
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- Worker –∑–Ω–∞–µ—Ç –æ MCP, Telegram, DB (–Ω–∞—Ä—É—à–µ–Ω–∏–µ SRP)
- –ù–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≤–æ—Ä–∫–µ—Ä—ã –¥–ª—è summary/digest
- –ñ—ë—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã

---

## –î–≤–∞ —Ç–∏–ø–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏

### 1. Task Summary (–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á)

**–¶–µ–ª—å:** –£—Ç—Ä–µ–Ω–Ω–∏–π brief –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –µ–≥–æ –∑–∞–¥–∞—á–∞—Ö.

**–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:** MongoDB collection `tasks`

**–ü–æ—Ç–æ–∫:**

```
User ‚Üí Telegram Bot / MCP Client
         ‚Üì
    MCP Tool: get_summary (reminder_tools.py)
         ‚Üì
    TaskRepository.list_tasks()
         ‚Üì
    _build_summary_query() ‚Üí MongoDB query
         ‚Üì
    _compute_task_stats() ‚Üí aggregation
         ‚Üì
    format_summary() ‚Üí "üåÖ Good morning! ..."
         ‚Üì
    SummaryWorker ‚Üí Telegram Bot ‚Üí User
```

**–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:**

```
üåÖ Good morning!

üìä Tasks: 5
üî¥ High priority: 2

Your tasks:

üî¥ Fix production bug
üü° Write documentation
üü¢ Review PR
...
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LLM —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é (—Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- ‚úÖ Timeframe: today, tomorrow, week, last_24h, last_7d

### 2. Channel Digest (–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤)

**–¶–µ–ª—å:** –í–µ—á–µ—Ä–Ω–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑ Telegram-–∫–∞–Ω–∞–ª–æ–≤.

**–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:** MongoDB collection `posts`

**–ü–æ—Ç–æ–∫:**

```
User ‚Üí Telegram Bot / MCP Client
         ‚Üì
    MCP Tool: get_channel_digest (channel_digest.py)
         ‚Üì
    PostRepository.get_posts_by_user_subscriptions()
         ‚Üì
    –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º
         ‚Üì
    –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞:
      ‚Üí _normalize_post_dates()
      ‚Üí _generate_summary()
           ‚Üì
      summarize_posts() (LLM)
           ‚Üì
      TokenCounter ‚Üí count_tokens()
           ‚Üì
      –ï—Å–ª–∏ > 3000 —Ç–æ–∫–µ–Ω–æ–≤:
        ‚Üí MapReduceSummarizer
             ‚Üí SemanticChunker
             ‚Üí Map phase: chunk ‚Üí summary
             ‚Üí Reduce phase: summaries ‚Üí final
      –ò–Ω–∞—á–µ:
        ‚Üí –ü—Ä—è–º–æ–π LLM prompt
           ‚Üì
      _clean_json_from_summary()
      clean_markdown()
           ‚Üì
    format_single_digest()
         ‚Üì
    SummaryWorker ‚Üí Telegram Bot ‚Üí User
```

**–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:**

```
üì∞ –î–∞–π–¥–∂–µ—Å—Ç –∫–∞–Ω–∞–ª–∞

üìå @techcrunch
üìä –ü–æ—Å—Ç–æ–≤: 12
–¢–µ–≥–∏: #tech, #ai

OpenAI –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é GPT-4 —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏. 
–ö–æ–º–ø–∞–Ω–∏—è –∞–Ω–æ–Ω—Å–∏—Ä–æ–≤–∞–ª–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Microsoft Azure. 
–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ API —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏.
...
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç LLM —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é (Mistral/OpenAI)
- ‚úÖ Map-Reduce –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
- ‚úÖ Adaptive max_sentences (8-15)
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- ‚úÖ Fallback –Ω–∞ bullet list

---

## –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
src/
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ task.py
‚îÇ   ‚îî‚îÄ‚îÄ value_objects/
‚îÇ       ‚îî‚îÄ‚îÄ task_summary.py         # TaskSummary, DigestItem, DigestMessage
‚îÇ
‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îú‚îÄ‚îÄ llm/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ summarizer.py          # summarize_posts, MapReduceSummarizer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chunker.py             # SemanticChunker, TextChunk
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ token_counter.py       # TokenCounter
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prompts.py             # get_map_prompt, get_reduce_prompt
‚îÇ   ‚îú‚îÄ‚îÄ clients/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ llm_client.py          # LLMClient, ResilientLLMClient
‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ       ‚îú‚îÄ‚îÄ task_repository.py     # TaskRepository
‚îÇ       ‚îî‚îÄ‚îÄ post_repository.py     # PostRepository
‚îÇ
‚îú‚îÄ‚îÄ presentation/
‚îÇ   ‚îî‚îÄ‚îÄ mcp/
‚îÇ       ‚îî‚îÄ‚îÄ tools/
‚îÇ           ‚îú‚îÄ‚îÄ reminder_tools.py           # get_summary MCP tool
‚îÇ           ‚îú‚îÄ‚îÄ _summary_helpers.py         # _build_summary_query, _compute_task_stats
‚îÇ           ‚îî‚îÄ‚îÄ channels/
‚îÇ               ‚îî‚îÄ‚îÄ channel_digest.py       # get_channel_digest MCP tool
‚îÇ
‚îî‚îÄ‚îÄ workers/
    ‚îú‚îÄ‚îÄ summary_worker.py          # SummaryWorker (scheduler)
    ‚îú‚îÄ‚îÄ data_fetchers.py           # get_summary_text, get_digest_texts
    ‚îî‚îÄ‚îÄ formatters.py              # format_summary, format_single_digest
```

### –†–∞–∑–º–µ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

| –§–∞–π–ª | –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|------|-----------|----------------|
| `summarizer.py` | 387 | LLM —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è, Map-Reduce, –æ—á–∏—Å—Ç–∫–∞ |
| `channel_digest.py` | 598 | MCP tools –¥–ª—è digest, –ø–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤ |
| `summary_worker.py` | 259 | Scheduler, –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |
| `formatters.py` | 219 | –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Telegram |
| `data_fetchers.py` | 253 | –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö |
| `reminder_tools.py` | 240 | MCP tools –¥–ª—è –∑–∞–¥–∞—á |

**–ü—Ä–æ–±–ª–µ–º–∞:** `channel_digest.py` (598 —Å—Ç—Ä–æ–∫) –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–æ "—Ñ–∞–π–ª <150 —Å—Ç—Ä–æ–∫" –∏ —Å–º–µ—à–∏–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É.

---

## –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ—Ç–æ–∫ 1: –£—Ç—Ä–µ–Ω–Ω–∏–π Task Summary

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Cron/Worker  ‚îÇ (Morning time: 09:00 UTC)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì every 60s check
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SummaryWorker            ‚îÇ
‚îÇ _send_morning_summary()  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì for each user_id
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ data_fetchers            ‚îÇ
‚îÇ get_summary_text()       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì mcp_client.call_tool("get_summary")
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MCP Server               ‚îÇ
‚îÇ @mcp.tool()              ‚îÇ
‚îÇ get_summary()            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì query MongoDB
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MongoDB tasks collection ‚îÇ
‚îÇ find({user_id, timeframe})‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì tasks[] + stats{}
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ formatters               ‚îÇ
‚îÇ format_summary()         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì formatted text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Telegram Bot API         ‚îÇ
‚îÇ send_message()           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–ª—é—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
1. Worker –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
2. –í—ã–∑–æ–≤ MCP tool —á–µ—Ä–µ–∑ HTTP/stdio
3. MongoDB query —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ deadline
4. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ LLM
5. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API

### –ü–æ—Ç–æ–∫ 2: –í–µ—á–µ—Ä–Ω–∏–π Channel Digest

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Cron/Worker  ‚îÇ (Evening time: 20:00 UTC)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì every 60s check
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SummaryWorker            ‚îÇ
‚îÇ _send_evening_digest()   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì for each user_id
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ data_fetchers            ‚îÇ
‚îÇ get_digest_texts()       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì mcp_client.call_tool("get_channel_digest")
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MCP Server               ‚îÇ
‚îÇ @mcp.tool()              ‚îÇ
‚îÇ get_channel_digest()     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì query MongoDB posts
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PostRepository           ‚îÇ
‚îÇ get_posts_by_user_       ‚îÇ
‚îÇ subscriptions()          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì posts[] grouped by channel
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ channel_digest.py        ‚îÇ
‚îÇ _generate_summary()      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì call LLM summarizer
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ summarizer.py            ‚îÇ
‚îÇ summarize_posts()        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì count tokens
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ TokenCounter             ‚îÇ
‚îÇ count_tokens()           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚Üí if > 3000 tokens:
       ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ   ‚îÇ MapReduceSummarizer    ‚îÇ
       ‚îÇ   ‚îÇ - SemanticChunker      ‚îÇ
       ‚îÇ   ‚îÇ - Map phase (parallel) ‚îÇ
       ‚îÇ   ‚îÇ - Reduce phase         ‚îÇ
       ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îî‚îÄ‚Üí else:
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ Direct LLM prompt      ‚îÇ
           ‚îÇ - ResilientLLMClient   ‚îÇ
           ‚îÇ - generate()           ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì clean response
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ _clean_json_from_        ‚îÇ
‚îÇ summary()                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì format for Telegram
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ formatters               ‚îÇ
‚îÇ format_single_digest()   ‚îÇ
‚îÇ clean_markdown()         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì formatted text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Telegram Bot API         ‚îÇ
‚îÇ send_message()           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–ª—é—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
1. Worker –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
2. –í—ã–∑–æ–≤ MCP tool —á–µ—Ä–µ–∑ HTTP/stdio
3. MongoDB query —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ date (last N hours)
4. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ—Å—Ç–æ–≤ –ø–æ –∫–∞–Ω–∞–ª–∞–º
5. **LLM —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è** (Map-Reduce –∏–ª–∏ –ø—Ä—è–º–∞—è)
6. –û—á–∏—Å—Ç–∫–∞ JSON/Markdown –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
7. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + –æ—Ç–ø—Ä–∞–≤–∫–∞ (–ø–æ –æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –Ω–∞ –∫–∞–Ω–∞–ª)

---

## Map-Reduce –∞–ª–≥–æ—Ä–∏—Ç–º

### –ü—Ä–æ–±–ª–µ–º–∞

Telegram –ø–æ—Å—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º–∏. –ï—Å–ª–∏ —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ—Å—Ç—ã –∑–∞ 24 —á–∞—Å–∞ –≤ –æ–¥–∏–Ω –ø—Ä–æ–º–ø—Ç, –º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –æ–∫–Ω–∞ LLM.

**–ü—Ä–∏–º–µ—Ä:**
- 50 –ø–æ—Å—Ç–æ–≤ √ó 500 —Å–∏–º–≤–æ–ª–æ–≤ = 25,000 —Å–∏–º–≤–æ–ª–æ–≤
- ‚âà 6,000+ —Ç–æ–∫–µ–Ω–æ–≤ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥–µ–ª–∏)
- –ü—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –¥–ª—è –º–Ω–æ–≥–∏—Ö –º–æ–¥–µ–ª–µ–π

### –†–µ—à–µ–Ω–∏–µ: Map-Reduce

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FULL TEXT (6000+ tokens)                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì SemanticChunker.chunk_text()
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ Split at sentence boundaries  ‚îÇ
         ‚îÇ max_tokens = 3000             ‚îÇ
         ‚îÇ overlap_tokens = 200          ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                               ‚îÇ
         ‚Üì                               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Chunk 1        ‚îÇ              ‚îÇ Chunk 2        ‚îÇ
‚îÇ (2800 tokens)  ‚îÇ              ‚îÇ (3200 tokens)  ‚îÇ
‚îÇ [overlap 200]  ‚îÇ              ‚îÇ [overlap 200]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                               ‚îÇ
         ‚îÇ MAP PHASE (parallel)          ‚îÇ
         ‚îÇ                               ‚îÇ
         ‚Üì get_map_prompt()              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LLM generate() ‚îÇ              ‚îÇ LLM generate() ‚îÇ
‚îÇ "5 key facts"  ‚îÇ              ‚îÇ "5 key facts"  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                               ‚îÇ
         ‚Üì                               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Summary 1      ‚îÇ              ‚îÇ Summary 2      ‚îÇ
‚îÇ (3-5 sentences)‚îÇ              ‚îÇ (3-5 sentences)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                               ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì combine summaries
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ Fragment 1:    ‚îÇ
                ‚îÇ Summary 1      ‚îÇ
                ‚îÇ                ‚îÇ
                ‚îÇ Fragment 2:    ‚îÇ
                ‚îÇ Summary 2      ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì REDUCE PHASE
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ LLM generate() ‚îÇ
                ‚îÇ get_reduce_    ‚îÇ
                ‚îÇ prompt()       ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ FINAL SUMMARY  ‚îÇ
                ‚îÇ (8 sentences)  ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Map-Reduce

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| `max_tokens` | 3000 | –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ –≤ chunk |
| `overlap_tokens` | 200 | Overlap –º–µ–∂–¥—É chunks |
| `map_max_tokens` | 600 | –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –≤—ã—Ö–æ–¥–µ Map —Ñ–∞–∑—ã |
| `reduce_max_tokens` | 2000 | –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –≤—ã—Ö–æ–¥–µ Reduce —Ñ–∞–∑—ã |
| `temperature` | 0.2 | Low temperature –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞ |
| `max_sentences` (map) | `max(3, max_sentences // 2)` | –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–∞ chunk |
| `max_sentences` (reduce) | 8 | –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –∏—Ç–æ–≥–æ–≤–æ–º summary |

### –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã

**Input:**

```
50 posts, 6000 tokens total
```

**Map Phase:**

```
Chunk 1 (3000 tokens, 20 posts):
‚Üí LLM: "–í—ã–¥–µ–ª–∏ 4 –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–∞"
‚Üí Output: "OpenAI –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ GPT-4. Microsoft –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª AI –≤ Office. ..."

Chunk 2 (3200 tokens, 20 posts):
‚Üí LLM: "–í—ã–¥–µ–ª–∏ 4 –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–∞"
‚Üí Output: "Tesla –≤—ã–ø—É—Å—Ç–∏–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ FSD. Apple –∞–Ω–æ–Ω—Å–∏—Ä–æ–≤–∞–ª–∞ Vision Pro. ..."
```

**Reduce Phase:**

```
Combined:
Fragment 1:
OpenAI –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ GPT-4. Microsoft –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª AI –≤ Office. ...

Fragment 2:
Tesla –≤—ã–ø—É—Å—Ç–∏–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ FSD. Apple –∞–Ω–æ–Ω—Å–∏—Ä–æ–≤–∞–ª–∞ Vision Pro. ...

‚Üí LLM: "–û–±—ä–µ–¥–∏–Ω–∏ –≤ 8 –∏—Ç–æ–≥–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"
‚Üí Output: "OpenAI –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ GPT-4 —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏. Microsoft –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª AI –≤ Office 365. Tesla –≤—ã–ø—É—Å—Ç–∏–ª–∞ FSD Beta 11. Apple –∞–Ω–æ–Ω—Å–∏—Ä–æ–≤–∞–ª–∞ Vision Pro —Å spatial computing. ..."
```

### –ú–µ—Ç—Ä–∏–∫–∏ (Prometheus)

```python
_summarization_duration = Histogram(
    "summarization_duration_seconds",
    "Time spent on summarization phases",
    ["phase"],  # "map" or "reduce"
)

_chunks_processed = Counter(
    "summarizer_chunks_processed_total",
    "Total number of chunks processed",
)
```

---

## –û—á–∏—Å—Ç–∫–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞

LLM —á–∞—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
- JSON –≤–º–µ—Å—Ç–æ plain text
- Markdown —Å–∏–º–≤–æ–ª—ã (* _ ` [ ])
- –ù—É–º–µ—Ä–∞—Ü–∏—é (1., 2., ...)
- –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –õ–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫

Telegram Bot API –ø–∞—Ä—Å–∏—Ç Markdown —Å—Ç—Ä–æ–≥–æ ‚Üí –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ ‚Üí —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è.

### –†–µ—à–µ–Ω–∏–µ 1: –û—á–∏—Å—Ç–∫–∞ JSON –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤

**–§—É–Ω–∫—Ü–∏—è:** `_clean_json_from_summary(summary: str) -> str`

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ JSON:**
   ```python
   if cleaned.startswith('{') or cleaned.startswith('['):
       # –ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
       parsed = json.loads(cleaned)
   ```

2. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ JSON:**
   ```python
   # –ü–æ–∏—Å–∫ –ø–æ–ª–µ–π: 'summary', 'text', 'content', 'response', 'message'
   for key in ['summary', 'text', 'content', ...]:
       if key in parsed:
           cleaned = parsed[key]
           break
   ```

3. **Regex –æ—á–∏—Å—Ç–∫–∞:**
   ```python
   # –£–¥–∞–ª–µ–Ω–∏–µ JSON objects
   cleaned = re.sub(r'\{[^{}]*\}', '', cleaned)
   # –£–¥–∞–ª–µ–Ω–∏–µ JSON arrays
   cleaned = re.sub(r'\[[^\[\]]*\]', '', cleaned)
   # –£–¥–∞–ª–µ–Ω–∏–µ field patterns: "key": "value"
   cleaned = re.sub(r'["\']?\w+["\']?\s*:\s*["\']?([^"\']+)["\']?', r'\1', cleaned)
   ```

4. **Fallback:**
   ```python
   if len(cleaned) < 10:
       return summary.strip()  # –í–µ—Ä–Ω—É—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª
   ```

### –†–µ—à–µ–Ω–∏–µ 2: –û—á–∏—Å—Ç–∫–∞ Markdown

**–§—É–Ω–∫—Ü–∏—è:** `clean_markdown(text: str) -> str`

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

1. **–£–¥–∞–ª–µ–Ω–∏–µ Markdown —Å–∏–º–≤–æ–ª–æ–≤:**
   ```python
   text = re.sub(r'[*_`]', '', text)
   text = re.sub(r'\[', '', text)
   text = re.sub(r'\]', '', text)
   text = re.sub(r'\(', '', text)
   text = re.sub(r'\)', '', text)
   text = re.sub(r'\\', '', text)
   ```

2. **–í—Ç–æ—Ä–æ–π –ø—Ä–æ—Ö–æ–¥ (escaped):**
   ```python
   text = text.replace('\\*', '').replace('\\_', '').replace('\\`', '')
   text = text.replace('\\[', '').replace('\\]', '')
   ```

3. **–û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤:**
   ```python
   text = re.sub(r'\n\n+', '\n\n', text)  # Max 2 newlines
   ```

### –†–µ—à–µ–Ω–∏–µ 3: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

```python
# 1. Split –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
sentences = re.split(r'[.!?]+', cleaned_summary)
sentences = [s.strip() for s in sentences if s.strip()]

# 2. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (word overlap)
unique_sentences = []
for sent in sentences:
    is_duplicate = False
    for existing in unique_sentences:
        words_sent = set(sent.lower().split())
        words_existing = set(existing.lower().split())
        overlap = len(words_sent & words_existing) / max(len(words_sent), len(words_existing))
        if overlap > 0.6:  # 60% overlap = duplicate
            is_duplicate = True
            break
    if not is_duplicate:
        unique_sentences.append(sent)

# 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ max_sentences
cleaned_summary = '. '.join(unique_sentences[:max_sentences])
```

### –†–µ—à–µ–Ω–∏–µ 4: –£–¥–∞–ª–µ–Ω–∏–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏

**Regex –ø–∞—Ç—Ç–µ—Ä–Ω—ã:**

```python
# –£–¥–∞–ª–µ–Ω–∏–µ "1. ", "2. ", ...
cleaned = re.sub(r'^\d+\.\s*', '', cleaned, flags=re.MULTILINE)

# –£–¥–∞–ª–µ–Ω–∏–µ "First post", "Second post", ...
cleaned = re.sub(r'^(In the )?(first|second|third|fourth|fifth)\s+post', '', 
                 cleaned, flags=re.IGNORECASE | re.MULTILINE)

# –£–¥–∞–ª–µ–Ω–∏–µ "The first post", "The second post", ...
cleaned = re.sub(r'^The (first|second|third|fourth|fifth)\s+post', '', 
                 cleaned, flags=re.IGNORECASE | re.MULTILINE)
```

### Pipeline –æ—á–∏—Å—Ç–∫–∏

```
LLM Response
    ‚Üì
_clean_json_from_summary()
    ‚Üì (remove JSON)
Remove numbering (re.sub)
    ‚Üì
Remove Markdown (* _ ` [ ])
    ‚Üì
Normalize quotes (" " ‚Üí ")
    ‚Üì
Remove bullet points (‚Ä¢ - *)
    ‚Üì
Normalize whitespace
    ‚Üì
Deduplicate sentences (>60% overlap)
    ‚Üì
Limit to max_sentences
    ‚Üì
clean_markdown() (final pass)
    ‚Üì
Formatted text
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### Environment Variables

**–§–∞–π–ª:** `.env`

```bash
# LLM Configuration
SUMMARIZER_LANGUAGE=ru
SUMMARIZER_TEMPERATURE=0.5
SUMMARIZER_MAX_TOKENS=2000

# Digest Configuration
DIGEST_SUMMARY_SENTENCES=8
DIGEST_SUMMARY_MAX_CHARS=3900
DIGEST_MAX_CHANNELS=10

# Worker Configuration
MORNING_SUMMARY_TIME=09:00
EVENING_DIGEST_TIME=20:00
QUIET_HOURS_START=00:00
QUIET_HOURS_END=08:00

# Debug Mode
DEBUG_NOTIFICATION_INTERVAL_MINUTES=0  # 0 = disabled, >0 = debug mode
```

### Settings Model

**–§–∞–π–ª:** `src/infrastructure/config/settings.py`

```python
class Settings(BaseSettings):
    # Digest settings
    digest_summary_sentences: int = Field(
        default=8,
        description="Number of sentences per channel in digest"
    )
    digest_summary_max_chars: int = Field(
        default=3900,
        description="Maximum characters per channel summary (Telegram limit is 4096)"
    )
    digest_max_channels: int = Field(
        default=10,
        description="Maximum channels to include in digest"
    )
    
    # Summarizer settings
    summarizer_language: str = Field(
        default="ru",
        description="Language for summaries (ru/en)"
    )
    summarizer_temperature: float = Field(
        default=0.5,
        description="Temperature for summarization (higher = more creative)"
    )
    summarizer_max_tokens: int = Field(
        default=2000,
        description="Max tokens for summarization (more = longer summaries)"
    )
    
    # Worker settings
    morning_summary_time: str = "09:00"
    evening_digest_time: str = "20:00"
    quiet_hours_start: str = "00:00"
    quiet_hours_end: str = "08:00"
    debug_notification_interval_minutes: int = 0
```

### Adaptive max_sentences

**–õ–æ–≥–∏–∫–∞ –≤ `channel_digest.py`:**

```python
base_sentences = settings.digest_summary_sentences  # 8
post_count = len(normalized_posts)

if post_count <= 5:
    max_sentences = base_sentences  # 8
elif post_count <= 15:
    max_sentences = min(base_sentences + 2, 12)  # 10-12
else:
    max_sentences = min(base_sentences + 4, 15)  # 12-15
```

**Rationale:**
- –ú–∞–ª–æ –ø–æ—Å—Ç–æ–≤ (1-5) ‚Üí –∫–æ—Ä–æ—Ç–∫–∏–π summary (8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
- –°—Ä–µ–¥–Ω–µ (6-15) ‚Üí —á—É—Ç—å –¥–ª–∏–Ω–Ω–µ–µ (10-12)
- –ú–Ω–æ–≥–æ (16+) ‚Üí –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ (12-15)

---

## –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥

### 1. –ù–∞—Ä—É—à–µ–Ω–∏–µ Clean Architecture

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Presentation layer (`channel_digest.py`) –≤—ã–∑—ã–≤–∞–µ—Ç Infrastructure (`summarize_posts()`)
- Application layer (`data_fetchers.py`) —Å–º–µ—à–∞–Ω —Å Presentation
- Domain –ª–æ–≥–∏–∫–∞ (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è, –æ—á–∏—Å—Ç–∫–∞) –≤ Infrastructure

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**

```
Presentation ‚Üí Application (Use Cases) ‚Üí Infrastructure
```

**–°–µ–π—á–∞—Å:**

```
Presentation ‚Üí Infrastructure (–Ω–∞–ø—Ä—è–º—É—é)
Application ‚Üí Infrastructure + Presentation (—Å–º–µ—à–∞–Ω–æ)
```

### 2. –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (>150 —Å—Ç—Ä–æ–∫)

| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ü—Ä–æ–±–ª–µ–º–∞ |
|------|-------|----------|
| `channel_digest.py` | 598 | –°–º–µ—à–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤, —Å–±–æ—Ä–∞ –ø–æ—Å—Ç–æ–≤, —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ |
| `summarizer.py` | 387 | –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ + LLM + Map-Reduce |
| `summary_worker.py` | 259 | Scheduler + –æ—Ç–ø—Ä–∞–≤–∫–∞ + MCP + Telegram |

**–†–µ—à–µ–Ω–∏–µ:**
- –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
- –í—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É –≤ use cases

### 3. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏

**–ü—Ä–∏–º–µ—Ä—ã:**

1. **–û—á–∏—Å—Ç–∫–∞ Markdown:**
   - `clean_markdown()` –≤ `formatters.py`
   - `_clean_json_from_summary()` –≤ `summarizer.py`
   - Regex –æ—á–∏—Å—Ç–∫–∞ –≤ `summarize_posts()`

2. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á:**
   - `_compute_task_stats()` –≤ `_summary_helpers.py`
   - –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ `_get_summary_from_db()` –≤ `data_fetchers.py`

3. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ digest:**
   - `format_single_digest()` + `format_digest()`
   - –î—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –ª–æ–≥–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏

### 4. –°–º–µ—à–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

**SummaryWorker:**
- ‚úÖ Scheduling (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏)
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚ùå –ó–Ω–∞–µ—Ç –æ MCP client
- ‚ùå –ó–Ω–∞–µ—Ç –æ Telegram Bot API
- ‚ùå –ó–Ω–∞–µ—Ç –æ MongoDB (–≤ debug —Ä–µ–∂–∏–º–µ)

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- Worker ‚Üí Use Case ‚Üí Repository ‚Üí DB
- Worker ‚Üí Notification Service ‚Üí Telegram

**data_fetchers.py:**
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- ‚ùå –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ presentation)
- ‚ùå –ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ DB (debug —Ä–µ–∂–∏–º)

### 5. –ñ—ë—Å—Ç–∫–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å —Å MCP

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Worker –∑–∞–≤–∏—Å–∏—Ç –æ—Ç MCP server
- –ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é –±–µ–∑ MCP
- –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `SummarizerService`
- MCP tool –∫–∞–∫ –æ–¥–∏–Ω –∏–∑ –∞–¥–∞–ø—Ç–µ—Ä–æ–≤

### 6. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ use cases

**–°–µ–π—á–∞—Å:**
- –õ–æ–≥–∏–∫–∞ —Ä–∞–∑–º–∞–∑–∞–Ω–∞ –ø–æ presentation, application, infrastructure

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**

```python
# src/application/use_cases/get_task_summary.py
class GetTaskSummaryUseCase:
    def __init__(
        self,
        task_repository: TaskRepository,
        stats_calculator: TaskStatsCalculator
    ):
        self.task_repo = task_repository
        self.stats_calc = stats_calculator
    
    async def execute(
        self,
        user_id: int,
        timeframe: str
    ) -> TaskSummary:
        # Pure business logic
        ...

# src/application/use_cases/generate_channel_digest.py
class GenerateChannelDigestUseCase:
    def __init__(
        self,
        post_repository: PostRepository,
        summarizer: Summarizer
    ):
        self.post_repo = post_repository
        self.summarizer = summarizer
    
    async def execute(
        self,
        user_id: int,
        hours: int
    ) -> DigestMessage:
        # Pure business logic
        ...
```

### 7. –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –ª–æ–≥–∏–∫–∏

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–µ—Å—Ç—ã:**
- ‚ùå Map-Reduce –∞–ª–≥–æ—Ä–∏—Ç–º (end-to-end)
- ‚ùå –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- ‚ùå Adaptive max_sentences
- ‚ùå Worker scheduling –ª–æ–≥–∏–∫–∞

**–ï—Å—Ç—å —Ç–µ—Å—Ç—ã:**
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ JSON (`test_summarizer_cleaning.py`)
- ‚úÖ Map-Reduce (–±–∞–∑–æ–≤—ã–µ, `test_summarizer_map_reduce.py`)
- ‚úÖ Summary helpers (`test_reminder_tools_summary_helpers.py`)

### 8. Hardcoded –∑–Ω–∞—á–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä—ã:**

```python
# summarizer.py
if cleaned and len(cleaned) > 20:  # Magic number
    cleaned_posts.append(cleaned[:500])  # Magic number

# channel_digest.py
if overlap > 0.6:  # Magic threshold
    is_duplicate = True

# formatters.py
if last_period > absolute_max * 0.7:  # Magic ratio
    return truncated[:last_period + 1]
```

**–†–µ—à–µ–Ω–∏–µ:**
- –í—ã–Ω–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–ª–∏ config

### 9. –ü—Ä–æ–±–ª–µ–º—ã —Å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Hardcoded emoji –∏ —Ç–µ–∫—Å—Ç—ã –≤ `formatters.py`
- –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤ –¥–ª—è UI
- –¢–æ–ª—å–∫–æ –ø—Ä–æ–º–ø—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç ru/en

**–†–µ—à–µ–Ω–∏–µ:**
- i18n —Å–∏—Å—Ç–µ–º–∞
- –í—ã–Ω–µ—Å—Ç–∏ UI —Ç–µ–∫—Å—Ç—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã

### 10. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry –ª–æ–≥–∏–∫–∏ –¥–ª—è LLM

**–ü—Ä–æ–±–ª–µ–º–∞:**

```python
for attempt in range(2):
    try:
        summary = await llm_client.generate(...)
        if summary and len(summary.strip()) > 10:
            return cleaned_summary
    except Exception as e:
        if attempt == 1:
            break
```

- –¢–æ–ª—å–∫–æ 2 –ø–æ–ø—ã—Ç–∫–∏
- –ù–µ—Ç exponential backoff
- –ù–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ (rate limit, timeout)

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `tenacity` –¥–ª—è retry
- –†–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ—à–∏–±–æ–∫

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

### –ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        WORKERS LAYER                         ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  SummaryWorker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Bot (aiogram)                  ‚îÇ
‚îÇ                      ‚îÇ                                       ‚îÇ
‚îÇ                      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí MCPClient                       ‚îÇ
‚îÇ                      ‚îÇ                                       ‚îÇ
‚îÇ                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí data_fetchers                   ‚îÇ
‚îÇ                              ‚Üì                               ‚îÇ
‚îÇ                              formatters                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     PRESENTATION LAYER                       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  MCP Tools ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí TaskRepository                 ‚îÇ
‚îÇ  - reminder_tools    ‚îÇ                                       ‚îÇ
‚îÇ  - channel_digest    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí PostRepository                 ‚îÇ
‚îÇ                      ‚îÇ                                       ‚îÇ
‚îÇ                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí summarize_posts() ‚ùå WRONG!     ‚îÇ
‚îÇ                              (should be use case)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  INFRASTRUCTURE LAYER                        ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  summarize_posts() ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí TokenCounter                   ‚îÇ
‚îÇ                      ‚îÇ                                       ‚îÇ
‚îÇ                      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí MapReduceSummarizer            ‚îÇ
‚îÇ                      ‚îÇ       ‚Üì                               ‚îÇ
‚îÇ                      ‚îÇ       SemanticChunker                 ‚îÇ
‚îÇ                      ‚îÇ       ‚Üì                               ‚îÇ
‚îÇ                      ‚îÇ       LLMClient                       ‚îÇ
‚îÇ                      ‚îÇ                                       ‚îÇ
‚îÇ                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ResilientLLMClient              ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  Repositories ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí MongoDB                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       DOMAIN LAYER                           ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  TaskSummary, DigestItem, DigestMessage (pure models)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–æ–±–ª–µ–º—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

1. **Presentation ‚Üí Infrastructure (–Ω–∞–ø—Ä—è–º—É—é):**
   - `channel_digest.py` ‚Üí `summarize_posts()`
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: Presentation ‚Üí Use Case ‚Üí Infrastructure

2. **Workers ‚Üí Presentation:**
   - `SummaryWorker` ‚Üí `data_fetchers.py`
   - `data_fetchers.py` ‚Üí `formatters.py` (—Å–º–µ—à–µ–Ω–∏–µ application + presentation)

3. **Circular dependencies (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ):**
   - `data_fetchers` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `formatters`
   - `formatters` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `settings`
   - –†–∏—Å–∫ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ

4. **God object:** `summarizer.py`
   - 387 —Å—Ç—Ä–æ–∫
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–µ–π:
     - –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
     - LLM —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
     - Map-Reduce
     - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
     - Fallback –ª–æ–≥–∏–∫–∞

---

## –†–µ–∑—é–º–µ: –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ ‚úÖ

1. **Map-Reduce –∞–ª–≥–æ—Ä–∏—Ç–º:**
   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
   - Semantic chunking —Å overlap
   - Parallel processing –≤ Map —Ñ–∞–∑–µ

2. **Resilient LLM Client:**
   - Auto-fallback –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏
   - Retry –ª–æ–≥–∏–∫–∞

3. **–û—á–∏—Å—Ç–∫–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ JSON/Markdown
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
   - –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

4. **Worker —Å–∏—Å—Ç–µ–º–∞:**
   - Scheduled notifications
   - Quiet hours
   - Debug mode

### –ß—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å ‚ùå

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
   - –ù–∞—Ä—É—à–µ–Ω–∏–µ Clean Architecture (Presentation ‚Üí Infrastructure)
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ use cases
   - –°–º–µ—à–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

2. **–ö–æ–¥:**
   - –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (>150 —Å—Ç—Ä–æ–∫)
   - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏
   - Magic numbers

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –ª–æ–≥–∏–∫–∏
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ integration —Ç–µ—Å—Ç–æ–≤ –¥–ª—è Map-Reduce

4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
   - Hardcoded –∑–Ω–∞—á–µ–Ω–∏—è
   - –ù–µ—Ç –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ UI

5. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
   - –ñ—ë—Å—Ç–∫–∞—è —Å–≤—è–∑—å —Å MCP
   - –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤

**Map Phase (Russian):**

```
–ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –ø–æ—Å—Ç–æ–≤ –∏–∑ Telegram-–∫–∞–Ω–∞–ª–∞.

–ó–ê–î–ê–ß–ê: –í—ã–¥–µ–ª–∏ 5 –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –∏–∑ —ç—Ç–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞. –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç ‚Äî –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
–§–∞–∫—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –†–ê–ó–ù–´–ú–ò –ø–æ —Å–º—ã—Å–ª—É. –ù–∏–∫–∞–∫–∏—Ö –ø–æ–≤—Ç–æ—Ä–æ–≤. –¢–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –∏ Markdown.

–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç, –ù–ï JSON, –ù–ï —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –¢–æ–ª—å–∫–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É.

–§–†–ê–ì–ú–ï–ù–¢:
1. OpenAI –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ GPT-4 Turbo —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º –æ–∫–Ω–æ–º –¥–æ 128K —Ç–æ–∫–µ–Ω–æ–≤.
2. –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –∏ JSON —Ä–µ–∂–∏–º –∏–∑ –∫–æ—Ä–æ–±–∫–∏.
3. –¶–µ–Ω–∞ —Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞ 50% –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π.
...

–ö–õ–Æ–ß–ï–í–´–ï –§–ê–ö–¢–´:
```

**Reduce Phase (Russian):**

```
–ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≥–æ Telegram-–∫–∞–Ω–∞–ª–∞.

–ó–ê–î–ê–ß–ê: –û–±—ä–µ–¥–∏–Ω–∏ –∏—Ö –≤ 8 –∏—Ç–æ–≥–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –æ–ø–∏—Å—ã–≤–∞—é—â–∏—Ö –≥–ª–∞–≤–Ω—ã–µ —Ç–µ–º—ã –∫–∞–Ω–∞–ª–∞. 
–ò–∑–±–µ–≥–∞–π –ø–æ–≤—Ç–æ—Ä–æ–≤. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –º—ã—Å–ª—å. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –∏ Markdown.

–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç, –ù–ï JSON, –ù–ï —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –¢–æ–ª—å–∫–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É.

–°–£–ú–ú–ê–†–ò–ó–ê–¶–ò–ò –§–†–ê–ì–ú–ï–ù–¢–û–í:
Fragment 1:
OpenAI –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ GPT-4 Turbo —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º –æ–∫–Ω–æ–º 128K. –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç JSON —Ä–µ–∂–∏–º. –¶–µ–Ω–∞ —Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞ 50%.

Fragment 2:
Microsoft –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª GPT-4 –≤ Copilot –¥–ª—è Office. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –§—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Word, Excel, PowerPoint.

–ò–¢–û–ì–û–í–ê–Ø –°–£–ú–ú–ê–†–ò–ó–ê–¶–ò–Ø:
```

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–¢–∏–ø–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|----------|
| Map phase duration | 2-5 —Å–µ–∫—É–Ω–¥ | –í—Ä–µ–º—è –Ω–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é –æ–¥–Ω–æ–≥–æ chunk |
| Reduce phase duration | 3-6 —Å–µ–∫—É–Ω–¥ | –í—Ä–µ–º—è –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ |
| Total (Map-Reduce) | 8-15 —Å–µ–∫—É–Ω–¥ | –ü–æ–ª–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è 2 chunks |
| Direct summarization | 3-7 —Å–µ–∫—É–Ω–¥ | –ü—Ä—è–º–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è (< 3000 —Ç–æ–∫–µ–Ω–æ–≤) |
| Chunks processed | 2-5 | –¢–∏–ø–∏—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ chunks |
| Token count | 4000-8000 | –¢–∏–ø–∏—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ø–æ—Å—Ç–∞—Ö |

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** 2025-11-04  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

