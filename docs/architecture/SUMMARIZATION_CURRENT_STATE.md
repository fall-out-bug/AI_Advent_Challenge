# Current State Summary

**Ğ”Ğ°Ñ‚Ğ°:** 2025-11-04
**Ğ¦ĞµĞ»ÑŒ:** Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ

---

## Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ

1. [ĞĞ±Ğ·Ğ¾Ñ€ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹](#Ğ¾Ğ±Ğ·Ğ¾Ñ€-ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹)
2. [ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²](#Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°-ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²)
3. [Ğ”Ğ²Ğ° Ñ‚Ğ¸Ğ¿Ğ° ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸](#Ğ´Ğ²Ğ°-Ñ‚Ğ¸Ğ¿Ğ°-ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸)
4. [Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²](#Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ-ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°-ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²)
5. [ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…](#Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¸-Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
6. [Map-Reduce Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼](#map-reduce-Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼)
7. [ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ](#Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°-Ğ¸-Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
8. [ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸](#ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ-Ğ¸-Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸)
9. [ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ¸ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ´Ğ¾Ğ»Ğ³](#Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹-Ğ¸-Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹-Ğ´Ğ¾Ğ»Ğ³)
10. [Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸](#Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸-Ğ¼ĞµĞ¶Ğ´Ñƒ-ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸)

---

## ĞĞ±Ğ·Ğ¾Ñ€ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ Ñ€ĞµÑˆĞ°ĞµÑ‚ **Ğ´Ğ²Ğµ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸**:

1. **Ğ¡ÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ** (Task Summary) - ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ñ overview Ğ·Ğ°Ğ´Ğ°Ñ‡
2. **Ğ¡ÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² Ğ¸Ğ· Telegram-ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²** (Channel Digest) - Ğ²ĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğµ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚Ñ‹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°

ĞĞ±Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ **Ğ¾Ğ±Ñ‰ÑƒÑ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ LLM-ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸**, Ğ½Ğ¾ Ğ¸Ğ¼ĞµÑÑ‚ Ñ€Ğ°Ğ·Ğ½ÑƒÑ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ, Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°.

### Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° (Clean Architecture)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRESENTATION LAYER                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ MCP Tools        â”‚  â”‚ Telegram Bot   â”‚  â”‚ Workers      â”‚â”‚
â”‚  â”‚ - reminder_tools â”‚  â”‚ (handlers)     â”‚  â”‚ - summary_   â”‚â”‚
â”‚  â”‚ - channel_digest â”‚  â”‚                â”‚  â”‚   worker     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   APPLICATION LAYER                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ Data Fetchers    â”‚  â”‚ Formatters     â”‚                   â”‚
â”‚  â”‚ - get_summary_   â”‚  â”‚ - format_      â”‚                   â”‚
â”‚  â”‚   text           â”‚  â”‚   summary      â”‚                   â”‚
â”‚  â”‚ - get_digest_    â”‚  â”‚ - format_      â”‚                   â”‚
â”‚  â”‚   texts          â”‚  â”‚   digest       â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 INFRASTRUCTURE LAYER                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ LLM Summarization Core                               â”‚   â”‚
â”‚  â”‚  - summarizer.py (summarize_posts)                  â”‚   â”‚
â”‚  â”‚  - MapReduceSummarizer                              â”‚   â”‚
â”‚  â”‚  - SemanticChunker                                  â”‚   â”‚
â”‚  â”‚  - TokenCounter                                     â”‚   â”‚
â”‚  â”‚  - Prompts (get_map_prompt, get_reduce_prompt)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ LLM Clients                                          â”‚   â”‚
â”‚  â”‚  - LLMClient (abstract)                             â”‚   â”‚
â”‚  â”‚  - ResilientLLMClient (auto-fallback)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Repositories                                         â”‚   â”‚
â”‚  â”‚  - TaskRepository                                   â”‚   â”‚
â”‚  â”‚  - PostRepository                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DOMAIN LAYER                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ Value Objects    â”‚  â”‚ Entities       â”‚                   â”‚
â”‚  â”‚ - TaskSummary    â”‚  â”‚ - Task         â”‚                   â”‚
â”‚  â”‚ - DigestItem     â”‚  â”‚ - Post         â”‚                   â”‚
â”‚  â”‚ - DigestMessage  â”‚  â”‚                â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²

### 1. Domain Layer (Ğ§Ğ¸ÑÑ‚Ğ°Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°)

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**
- `src/domain/value_objects/task_summary.py`
- `src/domain/entities/task.py`

**Value Objects:**

```python
class TaskSummary(BaseModel):
    """Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼"""
    total: int
    completed: int
    overdue: int
    high_priority: int
    timeframe: Optional[str]

class DigestItem(BaseModel):
    """Ğ”Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°"""
    channel: str
    summary: str
    post_count: int
    tags: List[str]

class DigestMessage(BaseModel):
    """ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚ Ğ²ÑĞµÑ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²"""
    items: List[DigestItem]
    generated_at_iso: Optional[str]
```

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:** Ğ§Ğ¸ÑÑ‚Ñ‹Ğµ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ñ‚Ğ¸Ğ¿Ğ¾Ğ².

---

### 2. Infrastructure Layer (Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸)

#### 2.1 LLM Summarization Core

**Ğ¤Ğ°Ğ¹Ğ»:** `src/infrastructure/llm/summarizer.py`

**ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ API:**

```python
async def summarize_posts(
    posts: List[dict],
    max_sentences: int = None,
    llm: LLMClient | None = None,
    time_period_hours: int = None
) -> str:
    """
    Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸.

    Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:
    1. ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² (_clean_text_for_summary)
    2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
    3. Ğ•ÑĞ»Ğ¸ > 3000 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² â†’ Map-Reduce
    4. Ğ•ÑĞ»Ğ¸ <= 3000 â†’ Ğ¿Ñ€ÑĞ¼Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
    5. Fallback Ğ½Ğ° bullet list Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
    """
```

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:**

1. **ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ°:**
   - Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ URL
   - Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ UTM Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
   - ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ²
   - Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ "Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ»ĞµĞµ"
   - ĞĞ±Ñ€ĞµĞ·ĞºĞ° Ğ´Ğ¾ 500 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² Ğ½Ğ° Ğ¿Ğ¾ÑÑ‚

2. **Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸:**
   - `TokenCounter.count_tokens()` â†’ Ğ¿Ğ¾Ğ´ÑÑ‡Ñ‘Ñ‚ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
   - Ğ•ÑĞ»Ğ¸ **> 3000 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²** â†’ `MapReduceSummarizer`
   - Ğ•ÑĞ»Ğ¸ **<= 3000 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²** â†’ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğº LLM

3. **Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°:**
   - Ğ ÑƒÑÑĞºĞ¸Ğ¹ ÑĞ·Ñ‹Ğº Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
   - Ğ¯Ğ²Ğ½Ñ‹Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸: "NO JSON, NO Markdown"
   - Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ (24 Ñ‡Ğ°ÑĞ° / 7 Ğ´Ğ½ĞµĞ¹)
   - Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹

4. **Retry Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°:**
   - 2 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
   - ĞĞ° Ğ¾ÑˆĞ¸Ğ±ĞºĞµ â†’ fallback Ğº bullet list

5. **ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°:**
   - Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ JSON Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ² (`_clean_json_from_summary`)
   - Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Markdown ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
   - Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ½ÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
   - Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ (>60% overlap)
   - ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ `max_sentences`

**ĞšĞ»Ğ°ÑÑ MapReduceSummarizer:**

```python
class MapReduceSummarizer:
    """Map-Reduce Ğ´Ğ»Ñ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ñ… Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²"""

    def __init__(
        self,
        llm: LLMClient,
        token_counter: TokenCounter,
        chunker: SemanticChunker,
        language: str = "ru"
    ):
        self.llm = llm
        self.token_counter = token_counter
        self.chunker = chunker
        self.language = language

    async def summarize_text(
        self,
        text: str,
        max_sentences: int = 8,
        temperature: float = 0.2,
        map_max_tokens: int = 600,
        reduce_max_tokens: int = 2000
    ) -> str:
        """
        Map phase: ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ chunk â†’ summaries[]
        Reduce phase: Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ summaries â†’ final_summary
        """
```

#### 2.2 Chunking & Token Counting

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**
- `src/infrastructure/llm/chunker.py`
- `src/infrastructure/llm/token_counter.py`

**SemanticChunker:**

```python
class SemanticChunker:
    """Ğ Ğ°Ğ·Ğ±Ğ¸ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ½Ğ° chunks Ñ overlap"""

    def __init__(
        self,
        token_counter: TokenCounter,
        max_tokens: int = 3000,
        overlap_tokens: int = 200
    ):
        # Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°Ğ¼ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ (regex)
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ overlap Ğ¼ĞµĞ¶Ğ´Ñƒ chunks Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
```

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**
1. Regex split Ğ¿Ğ¾ `.!?â€¦` + Ğ·Ğ°Ğ³Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ğ±ÑƒĞºĞ²Ğ°
2. ĞŸĞ¾Ğ´ÑÑ‡Ñ‘Ñ‚ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
3. Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ² chunks â‰¤ max_tokens
4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ overlap_tokens Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ chunk

#### 2.3 Prompts

**Ğ¤Ğ°Ğ¹Ğ»:** `src/infrastructure/llm/prompts.py`

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:**

```python
def get_map_prompt(text: str, language: str, max_sentences: int) -> str:
    """ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ Map Ñ„Ğ°Ğ·Ñ‹ (chunk â†’ key facts)"""
    # Ğ ÑƒÑÑĞºĞ¸Ğ¹: "Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸ N ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ñ„Ğ°ĞºÑ‚Ğ¾Ğ² Ğ¸Ğ· ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚Ğ°"
    # ĞĞ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¸Ğ¹: "Summarize in N sentences"

def get_reduce_prompt(summaries: str, language: str, max_sentences: int) -> str:
    """ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ Reduce Ñ„Ğ°Ğ·Ñ‹ (summaries â†’ final)"""
    # Ğ ÑƒÑÑĞºĞ¸Ğ¹: "ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½Ğ¸ ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ² N Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹"
```

**ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²:**
- âŒ NO JSON, NO Markdown
- âœ… Plain text only
- âœ… Ğ¯Ğ²Ğ½Ğ°Ñ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ¿Ğ¾ ÑĞ·Ñ‹ĞºÑƒ (ru/en)
- âœ… Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ñ„Ğ°ĞºÑ‚Ğ¾Ğ²
- âœ… Ğ¯Ğ²Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹

#### 2.4 Repositories

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**
- `src/infrastructure/repositories/task_repository.py`
- `src/infrastructure/repositories/post_repository.py`

**TaskRepository:**
- `list_tasks(user_id, status, limit)` â†’ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
- `create_task(TaskIn)` â†’ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
- `update_task(task_id, updates)` â†’ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
- `delete_task(task_id)` â†’ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ

**PostRepository:**
- `get_posts_by_user_subscriptions(user_id, hours)` â†’ Ğ¿Ğ¾ÑÑ‚Ñ‹ Ğ¸Ğ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº
- `save_post(post)` â†’ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ğ°
- Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ (datetime range)

---

### 3. Application Layer (ĞÑ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ)

#### 3.1 Data Fetchers

**Ğ¤Ğ°Ğ¹Ğ»:** `src/workers/data_fetchers.py`

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:**

```python
async def get_summary_text(
    mcp_client: MCPClientProtocol,
    user_id: int,
    timeframe: str = "today",
    debug: bool = False
) -> Optional[str]:
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ summary Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.

    Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:
    - Ğ•ÑĞ»Ğ¸ debug=True â†’ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ² MongoDB
    - Ğ˜Ğ½Ğ°Ñ‡Ğµ â†’ Ğ²Ñ‹Ğ·Ğ¾Ğ² MCP tool "get_summary"
    - Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· format_summary()
    """

async def get_digest_texts(
    mcp_client: MCPClientProtocol,
    user_id: int,
    debug: bool = False
) -> list[str]:
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ digest Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ² Ğ¸Ğ· ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ².

    Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:
    - Ğ’Ñ‹Ğ·Ğ¾Ğ² MCP tool "get_channel_digest"
    - Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· format_single_digest()
    - Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº (Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ñ‚ĞµĞºÑÑ‚Ñƒ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ»)
    """
```

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹:**
- Ğ¡Ğ¼ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ (Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ + Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
- ĞŸÑ€ÑĞ¼Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ² DB Ğ² debug Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ
- ĞĞµÑ‚ Ğ°Ğ±ÑÑ‚Ñ€Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ½Ğ°Ğ´ MCP client

#### 3.2 Formatters

**Ğ¤Ğ°Ğ¹Ğ»:** `src/workers/formatters.py`

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:**

```python
def format_summary(
    tasks: list[dict],
    stats: dict,
    debug: bool = False
) -> str:
    """
    Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ task summary Ğ´Ğ»Ñ Telegram.

    Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚:
    ğŸŒ… Good morning! (Ğ¸Ğ»Ğ¸ ğŸ” Debug Summary)
    ğŸ“Š Tasks: N
    ğŸ”´ High priority: M

    ğŸ”´ Task 1
    ğŸŸ¡ Task 2
    ...
    """

def format_single_digest(
    digest: dict,
    debug: bool = False
) -> str:
    """
    Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ channel digest.

    Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚:
    ğŸ“° Ğ”Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚ ĞºĞ°Ğ½Ğ°Ğ»Ğ°
    ğŸ“Œ @channel_name
    ğŸ“Š ĞŸĞ¾ÑÑ‚Ğ¾Ğ²: N
    Ğ¢ĞµĞ³Ğ¸: #tag1, #tag2

    Summary text...
    """

def clean_markdown(text: str) -> str:
    """
    ĞĞ³Ñ€ĞµÑÑĞ¸Ğ²Ğ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Markdown.

    Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚:
    - * _ ` [ ] ( ) \
    - Escaped ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹
    - ĞœĞ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑÑ‹ ÑÑ‚Ñ€Ğ¾Ğº
    """
```

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹:**
- ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Markdown Ğ² formatters (Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ² infrastructure)
- Ğ–Ñ‘ÑÑ‚ĞºĞ¾ Ğ·Ğ°ĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ emoji Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹
- ĞĞµÑ‚ Ğ»Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

#### 3.3 Summary Helpers

**Ğ¤Ğ°Ğ¹Ğ»:** `src/presentation/mcp/tools/_summary_helpers.py`

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:**

```python
def _build_summary_query(
    user_id: int,
    timeframe: str,
    now: datetime
) -> Dict[str, Any]:
    """
    ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ MongoDB query Ğ´Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡.

    Timeframes:
    - "today" â†’ deadline [start_of_day, end_of_day)
    - "tomorrow" â†’ deadline [tomorrow_start, tomorrow_end)
    - "week" â†’ deadline [today, +7 days)
    - "last_24h" â†’ empty query (filter in memory)
    - "last_7d" â†’ deadline [now-7d, now)
    """

def _compute_task_stats(
    tasks: list[dict],
    now_iso: str
) -> Dict[str, int]:
    """
    Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼.

    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚:
    - total: len(tasks)
    - completed: count(completed=True)
    - overdue: count(deadline < now AND completed=False)
    - high_priority: count(priority="high")
    """
```

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹:**
- Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ² `_summary_helpers.py` Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ² use case
- Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ñ… Ğ¼ĞµÑÑ‚Ğ°Ñ…

---

### 4. Presentation Layer (API & Workers)

#### 4.1 MCP Tools

**Ğ¤Ğ°Ğ¹Ğ»:** `src/presentation/mcp/tools/reminder_tools.py`

```python
@mcp.tool()
async def get_summary(
    user_id: int,
    timeframe: str = "today"
) -> Dict[str, Any]:
    """
    MCP tool Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ summary Ğ·Ğ°Ğ´Ğ°Ñ‡.

    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚:
    {
        "tasks": [...],
        "stats": {
            "total": N,
            "completed": M,
            "overdue": K,
            "high_priority": P
        }
    }
    """
```

**Ğ¤Ğ°Ğ¹Ğ»:** `src/presentation/mcp/tools/channels/channel_digest.py`

```python
@mcp.tool()
async def get_channel_digest(
    user_id: int,
    hours: int = 24
) -> Dict[str, Any]:
    """
    MCP tool Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ digest ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ².

    Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:
    1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚Ñ‹ Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ N Ñ‡Ğ°ÑĞ¾Ğ²
    3. Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ğ¼
    4. Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°:
       - _normalize_post_dates()
       - _generate_summary() â†’ Ğ²Ñ‹Ğ·Ğ¾Ğ² summarize_posts()
    5. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ {"digests": [...]}
    """

@mcp.tool()
async def get_channel_digest_by_name(
    user_id: int,
    channel_username: str,
    hours: int = 72
) -> Dict[str, Any]:
    """
    Digest Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°.

    Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:
    - ĞŸĞ¾Ğ¸ÑĞº ĞºĞ°Ğ½Ğ°Ğ»Ğ° (case-insensitive, partial match, metadata)
    - Auto-subscribe ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½
    - ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° collect_posts ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    - Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
    - Adaptive max_sentences (8-15 Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²)
    - Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ summary
    """
```

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹:**
- `_generate_summary()` Ğ¸ `_normalize_post_dates()` Ğ² presentation ÑĞ»Ğ¾Ğµ
- Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ¸ÑĞºĞ° ĞºĞ°Ğ½Ğ°Ğ»Ğ° (Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ² domain/application)
- ĞŸÑ€ÑĞ¼Ñ‹Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ `summarize_posts()` Ğ¸Ğ· presentation

#### 4.2 Summary Worker

**Ğ¤Ğ°Ğ¹Ğ»:** `src/workers/summary_worker.py`

```python
class SummaryWorker:
    """Background worker Ğ´Ğ»Ñ scheduled ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"""

    def __init__(
        self,
        bot_token: str,
        mcp_url: Optional[str] = None
    ):
        self.bot = Bot(token=bot_token)
        self.mcp = get_mcp_client(server_url=mcp_url)
        self.settings = get_settings()

    async def run(self) -> None:
        """
        Main loop:
        1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 60 ÑĞµĞºÑƒĞ½Ğ´
        2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° quiet hours
        3. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° morning summary (morning_summary_time)
        4. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° evening digest (evening_digest_time)
        5. Debug mode: Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ N Ğ¼Ğ¸Ğ½ÑƒÑ‚
        """

    async def _send_morning_summary(self) -> None:
        """Ğ£Ñ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ summary Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹"""
        # get_summary_text() â†’ send_with_retry()

    async def _send_evening_digest(self) -> None:
        """Ğ’ĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğ¹ digest ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹"""
        # get_digest_texts() â†’ send_with_retry() for each
```

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹:**
- Worker Ğ·Ğ½Ğ°ĞµÑ‚ Ğ¾ MCP, Telegram, DB (Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ SRP)
- ĞĞµÑ‚ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ½Ğ° Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñ‹ Ğ´Ğ»Ñ summary/digest
- Ğ–Ñ‘ÑÑ‚ĞºĞ¾ Ğ·Ğ°ĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ñ‹

---

## Ğ”Ğ²Ğ° Ñ‚Ğ¸Ğ¿Ğ° ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### 1. Task Summary (Ğ¡ÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡)

**Ğ¦ĞµĞ»ÑŒ:** Ğ£Ñ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ brief Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¾ ĞµĞ³Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ñ….

**Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:** MongoDB collection `tasks`

**ĞŸĞ¾Ñ‚Ğ¾Ğº:**

```
User â†’ Telegram Bot / MCP Client
         â†“
    MCP Tool: get_summary (reminder_tools.py)
         â†“
    TaskRepository.list_tasks()
         â†“
    _build_summary_query() â†’ MongoDB query
         â†“
    _compute_task_stats() â†’ aggregation
         â†“
    format_summary() â†’ "ğŸŒ… Good morning! ..."
         â†“
    SummaryWorker â†’ Telegram Bot â†’ User
```

**Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°:**

```
ğŸŒ… Good morning!

ğŸ“Š Tasks: 5
ğŸ”´ High priority: 2

Your tasks:

ğŸ”´ Fix production bug
ğŸŸ¡ Write documentation
ğŸŸ¢ Review PR
...
```

**ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸:**
- âŒ ĞĞ• Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ LLM ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
- âœ… ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ†Ğ¸Ñ Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
- âœ… Timeframe: today, tomorrow, week, last_24h, last_7d

### 2. Channel Digest (Ğ¡ÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²)

**Ğ¦ĞµĞ»ÑŒ:** Ğ’ĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğ¹ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° Ğ¸Ğ· Telegram-ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ².

**Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:** MongoDB collection `posts`

**ĞŸĞ¾Ñ‚Ğ¾Ğº:**

```
User â†’ Telegram Bot / MCP Client
         â†“
    MCP Tool: get_channel_digest (channel_digest.py)
         â†“
    PostRepository.get_posts_by_user_subscriptions()
         â†“
    Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ğ¼
         â†“
    Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°:
      â†’ _normalize_post_dates()
      â†’ _generate_summary()
           â†“
      summarize_posts() (LLM)
           â†“
      TokenCounter â†’ count_tokens()
           â†“
      Ğ•ÑĞ»Ğ¸ > 3000 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²:
        â†’ MapReduceSummarizer
             â†’ SemanticChunker
             â†’ Map phase: chunk â†’ summary
             â†’ Reduce phase: summaries â†’ final
      Ğ˜Ğ½Ğ°Ñ‡Ğµ:
        â†’ ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ LLM prompt
           â†“
      _clean_json_from_summary()
      clean_markdown()
           â†“
    format_single_digest()
         â†“
    SummaryWorker â†’ Telegram Bot â†’ User
```

**Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°:**

```
ğŸ“° Ğ”Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚ ĞºĞ°Ğ½Ğ°Ğ»Ğ°

ğŸ“Œ @techcrunch
ğŸ“Š ĞŸĞ¾ÑÑ‚Ğ¾Ğ²: 12
Ğ¢ĞµĞ³Ğ¸: #tech, #ai

OpenAI Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ½Ğ¾Ğ²ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ GPT-4 Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑĞ¼Ğ¸.
ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ Ğ°Ğ½Ğ¾Ğ½ÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ° Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ Microsoft Azure.
Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº API Ñ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ°Ğ¼Ğ¸.
...
```

**ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸:**
- âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ LLM ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (Mistral/OpenAI)
- âœ… Map-Reduce Ğ´Ğ»Ñ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ñ… Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²
- âœ… Adaptive max_sentences (8-15)
- âœ… ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¸ Ğ´ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
- âœ… Fallback Ğ½Ğ° bullet list

---

## Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²

### Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

```
src/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â””â”€â”€ task.py
â”‚   â””â”€â”€ value_objects/
â”‚       â””â”€â”€ task_summary.py         # TaskSummary, DigestItem, DigestMessage
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”œâ”€â”€ summarizer.py          # summarize_posts, MapReduceSummarizer
â”‚   â”‚   â”œâ”€â”€ chunker.py             # SemanticChunker, TextChunk
â”‚   â”‚   â”œâ”€â”€ token_counter.py       # TokenCounter
â”‚   â”‚   â””â”€â”€ prompts.py             # get_map_prompt, get_reduce_prompt
â”‚   â”œâ”€â”€ clients/
â”‚   â”‚   â””â”€â”€ llm_client.py          # LLMClient, ResilientLLMClient
â”‚   â””â”€â”€ repositories/
â”‚       â”œâ”€â”€ task_repository.py     # TaskRepository
â”‚       â””â”€â”€ post_repository.py     # PostRepository
â”‚
â”œâ”€â”€ presentation/
â”‚   â””â”€â”€ mcp/
â”‚       â””â”€â”€ tools/
â”‚           â”œâ”€â”€ reminder_tools.py           # get_summary MCP tool
â”‚           â”œâ”€â”€ _summary_helpers.py         # _build_summary_query, _compute_task_stats
â”‚           â””â”€â”€ channels/
â”‚               â””â”€â”€ channel_digest.py       # get_channel_digest MCP tool
â”‚
â””â”€â”€ workers/
    â”œâ”€â”€ summary_worker.py          # SummaryWorker (scheduler)
    â”œâ”€â”€ data_fetchers.py           # get_summary_text, get_digest_texts
    â””â”€â”€ formatters.py              # format_summary, format_single_digest
```

### Ğ Ğ°Ğ·Ğ¼ĞµÑ€ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²

| Ğ¤Ğ°Ğ¹Ğ» | Ğ¡Ñ‚Ñ€Ğ¾Ğº ĞºĞ¾Ğ´Ğ° | ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ |
|------|-----------|----------------|
| `summarizer.py` | 387 | LLM ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ, Map-Reduce, Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° |
| `channel_digest.py` | 598 | MCP tools Ğ´Ğ»Ñ digest, Ğ¿Ğ¾Ğ¸ÑĞº ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² |
| `summary_worker.py` | 259 | Scheduler, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ |
| `formatters.py` | 219 | Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Telegram |
| `data_fetchers.py` | 253 | ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… |
| `reminder_tools.py` | 240 | MCP tools Ğ´Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡ |

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** `channel_digest.py` (598 ÑÑ‚Ñ€Ğ¾Ğº) Ğ½Ğ°Ñ€ÑƒÑˆĞ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ "Ñ„Ğ°Ğ¹Ğ» <150 ÑÑ‚Ñ€Ğ¾Ğº" Ğ¸ ÑĞ¼ĞµÑˆĞ¸Ğ²Ğ°ĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ.

---

## ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### ĞŸĞ¾Ñ‚Ğ¾Ğº 1: Ğ£Ñ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Task Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cron/Worker  â”‚ (Morning time: 09:00 UTC)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ every 60s check
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SummaryWorker            â”‚
â”‚ _send_morning_summary()  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ for each user_id
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ data_fetchers            â”‚
â”‚ get_summary_text()       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ mcp_client.call_tool("get_summary")
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MCP Server               â”‚
â”‚ @mcp.tool()              â”‚
â”‚ get_summary()            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ query MongoDB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MongoDB tasks collection â”‚
â”‚ find({user_id, timeframe})â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ tasks[] + stats{}
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ formatters               â”‚
â”‚ format_summary()         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ formatted text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Telegram Bot API         â”‚
â”‚ send_message()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸:**
1. Worker Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²Ñ€ĞµĞ¼Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 60 ÑĞµĞºÑƒĞ½Ğ´
2. Ğ’Ñ‹Ğ·Ğ¾Ğ² MCP tool Ñ‡ĞµÑ€ĞµĞ· HTTP/stdio
3. MongoDB query Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¿Ğ¾ deadline
4. Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±ĞµĞ· LLM
5. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· Telegram Bot API

### ĞŸĞ¾Ñ‚Ğ¾Ğº 2: Ğ’ĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğ¹ Channel Digest

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cron/Worker  â”‚ (Evening time: 20:00 UTC)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ every 60s check
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SummaryWorker            â”‚
â”‚ _send_evening_digest()   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ for each user_id
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ data_fetchers            â”‚
â”‚ get_digest_texts()       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ mcp_client.call_tool("get_channel_digest")
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MCP Server               â”‚
â”‚ @mcp.tool()              â”‚
â”‚ get_channel_digest()     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ query MongoDB posts
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostRepository           â”‚
â”‚ get_posts_by_user_       â”‚
â”‚ subscriptions()          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ posts[] grouped by channel
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ channel_digest.py        â”‚
â”‚ _generate_summary()      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ call LLM summarizer
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ summarizer.py            â”‚
â”‚ summarize_posts()        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ count tokens
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TokenCounter             â”‚
â”‚ count_tokens()           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â†’ if > 3000 tokens:
       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚ MapReduceSummarizer    â”‚
       â”‚   â”‚ - SemanticChunker      â”‚
       â”‚   â”‚ - Map phase (parallel) â”‚
       â”‚   â”‚ - Reduce phase         â”‚
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â†’ else:
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Direct LLM prompt      â”‚
           â”‚ - ResilientLLMClient   â”‚
           â”‚ - generate()           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ clean response
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _clean_json_from_        â”‚
â”‚ summary()                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ format for Telegram
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ formatters               â”‚
â”‚ format_single_digest()   â”‚
â”‚ clean_markdown()         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ formatted text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Telegram Bot API         â”‚
â”‚ send_message()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸:**
1. Worker Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²Ñ€ĞµĞ¼Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 60 ÑĞµĞºÑƒĞ½Ğ´
2. Ğ’Ñ‹Ğ·Ğ¾Ğ² MCP tool Ñ‡ĞµÑ€ĞµĞ· HTTP/stdio
3. MongoDB query Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¿Ğ¾ date (last N hours)
4. Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² Ğ¿Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ğ¼
5. **LLM ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ** (Map-Reduce Ğ¸Ğ»Ğ¸ Ğ¿Ñ€ÑĞ¼Ğ°Ñ)
6. ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° JSON/Markdown Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²
7. Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ + Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° (Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ»)

---

## Map-Reduce Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°

Telegram Ğ¿Ğ¾ÑÑ‚Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¼Ğ¸. Ğ•ÑĞ»Ğ¸ ÑÑƒĞ¼Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ¿Ğ¾ÑÑ‚Ñ‹ Ğ·Ğ° 24 Ñ‡Ğ°ÑĞ° Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚, Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºĞ½Ğ° LLM.

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:**
- 50 Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² Ã— 500 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² = 25,000 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
- â‰ˆ 6,000+ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² (Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸)
- ĞŸÑ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ»Ñ Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹

### Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Map-Reduce

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FULL TEXT (6000+ tokens)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“ SemanticChunker.chunk_text()
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Split at sentence boundaries  â”‚
         â”‚ max_tokens = 3000             â”‚
         â”‚ overlap_tokens = 200          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                               â”‚
         â†“                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chunk 1        â”‚              â”‚ Chunk 2        â”‚
â”‚ (2800 tokens)  â”‚              â”‚ (3200 tokens)  â”‚
â”‚ [overlap 200]  â”‚              â”‚ [overlap 200]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                               â”‚
         â”‚ MAP PHASE (parallel)          â”‚
         â”‚                               â”‚
         â†“ get_map_prompt()              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLM generate() â”‚              â”‚ LLM generate() â”‚
â”‚ "5 key facts"  â”‚              â”‚ "5 key facts"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                               â”‚
         â†“                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Summary 1      â”‚              â”‚ Summary 2      â”‚
â”‚ (3-5 sentences)â”‚              â”‚ (3-5 sentences)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“ combine summaries
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Fragment 1:    â”‚
                â”‚ Summary 1      â”‚
                â”‚                â”‚
                â”‚ Fragment 2:    â”‚
                â”‚ Summary 2      â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“ REDUCE PHASE
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ LLM generate() â”‚
                â”‚ get_reduce_    â”‚
                â”‚ prompt()       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ FINAL SUMMARY  â”‚
                â”‚ (8 sentences)  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Map-Reduce

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|----------|----------|----------|
| `max_tokens` | 3000 | ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ² chunk |
| `overlap_tokens` | 200 | Overlap Ğ¼ĞµĞ¶Ğ´Ñƒ chunks |
| `map_max_tokens` | 600 | ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğµ Map Ñ„Ğ°Ğ·Ñ‹ |
| `reduce_max_tokens` | 2000 | ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğµ Reduce Ñ„Ğ°Ğ·Ñ‹ |
| `temperature` | 0.2 | Low temperature Ğ´Ğ»Ñ Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ¸Ğ·Ğ¼Ğ° |
| `max_sentences` (map) | `max(3, max_sentences // 2)` | ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ½Ğ° chunk |
| `max_sentences` (reduce) | 8 | ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼ summary |

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹

**Input:**

```
50 posts, 6000 tokens total
```

**Map Phase:**

```
Chunk 1 (3000 tokens, 20 posts):
â†’ LLM: "Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸ 4 ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ñ„Ğ°ĞºÑ‚Ğ°"
â†’ Output: "OpenAI Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ° GPT-4. Microsoft Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ» AI Ğ² Office. ..."

Chunk 2 (3200 tokens, 20 posts):
â†’ LLM: "Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸ 4 ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ñ„Ğ°ĞºÑ‚Ğ°"
â†’ Output: "Tesla Ğ²Ñ‹Ğ¿ÑƒÑÑ‚Ğ¸Ğ»Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ FSD. Apple Ğ°Ğ½Ğ¾Ğ½ÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ° Vision Pro. ..."
```

**Reduce Phase:**

```
Combined:
Fragment 1:
OpenAI Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ° GPT-4. Microsoft Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ» AI Ğ² Office. ...

Fragment 2:
Tesla Ğ²Ñ‹Ğ¿ÑƒÑÑ‚Ğ¸Ğ»Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ FSD. Apple Ğ°Ğ½Ğ¾Ğ½ÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ° Vision Pro. ...

â†’ LLM: "ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½Ğ¸ Ğ² 8 Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹"
â†’ Output: "OpenAI Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ° GPT-4 Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑĞ¼Ğ¸. Microsoft Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ» AI Ğ² Office 365. Tesla Ğ²Ñ‹Ğ¿ÑƒÑÑ‚Ğ¸Ğ»Ğ° FSD Beta 11. Apple Ğ°Ğ½Ğ¾Ğ½ÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ° Vision Pro Ñ spatial computing. ..."
```

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (Prometheus)

```python
_summarization_duration = Histogram(
    "summarization_duration_seconds",
    "Time spent on summarization phases",
    ["phase"],  # "map" or "reduce"
)

_chunks_processed = Counter(
    "summarizer_chunks_processed_total",
    "Total number of chunks processed",
)
```

---

## ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°

LLM Ñ‡Ğ°ÑÑ‚Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚:
- JSON Ğ²Ğ¼ĞµÑÑ‚Ğ¾ plain text
- Markdown ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ (* _ ` [ ])
- ĞÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸Ñ (1., 2., ...)
- Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒÑÑ‰Ğ¸ĞµÑÑ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
- Ğ›Ğ¸ÑˆĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹ Ğ¸ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑÑ‹ ÑÑ‚Ñ€Ğ¾Ğº

Telegram Bot API Ğ¿Ğ°Ñ€ÑĞ¸Ñ‚ Markdown ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ â†’ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° â†’ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑÑ‚ÑÑ.

### Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ 1: ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° JSON Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ:** `_clean_json_from_summary(summary: str) -> str`

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° JSON:**
   ```python
   if cleaned.startswith('{') or cleaned.startswith('['):
       # ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ°
       parsed = json.loads(cleaned)
   ```

2. **Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¸Ğ· JSON:**
   ```python
   # ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ĞµĞ¹: 'summary', 'text', 'content', 'response', 'message'
   for key in ['summary', 'text', 'content', ...]:
       if key in parsed:
           cleaned = parsed[key]
           break
   ```

3. **Regex Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°:**
   ```python
   # Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ JSON objects
   cleaned = re.sub(r'\{[^{}]*\}', '', cleaned)
   # Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ JSON arrays
   cleaned = re.sub(r'\[[^\[\]]*\]', '', cleaned)
   # Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ field patterns: "key": "value"
   cleaned = re.sub(r'["\']?\w+["\']?\s*:\s*["\']?([^"\']+)["\']?', r'\1', cleaned)
   ```

4. **Fallback:**
   ```python
   if len(cleaned) < 10:
       return summary.strip()  # Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»
   ```

### Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ 2: ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Markdown

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ:** `clean_markdown(text: str) -> str`

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Markdown ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²:**
   ```python
   text = re.sub(r'[*_`]', '', text)
   text = re.sub(r'\[', '', text)
   text = re.sub(r'\]', '', text)
   text = re.sub(r'\(', '', text)
   text = re.sub(r'\)', '', text)
   text = re.sub(r'\\', '', text)
   ```

2. **Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ (escaped):**
   ```python
   text = text.replace('\\*', '').replace('\\_', '').replace('\\`', '')
   text = text.replace('\\[', '').replace('\\]', '')
   ```

3. **ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¾Ğ²:**
   ```python
   text = re.sub(r'\n\n+', '\n\n', text)  # Max 2 newlines
   ```

### Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ 3: Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

```python
# 1. Split Ğ½Ğ° Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
sentences = re.split(r'[.!?]+', cleaned_summary)
sentences = [s.strip() for s in sentences if s.strip()]

# 2. Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ (word overlap)
unique_sentences = []
for sent in sentences:
    is_duplicate = False
    for existing in unique_sentences:
        words_sent = set(sent.lower().split())
        words_existing = set(existing.lower().split())
        overlap = len(words_sent & words_existing) / max(len(words_sent), len(words_existing))
        if overlap > 0.6:  # 60% overlap = duplicate
            is_duplicate = True
            break
    if not is_duplicate:
        unique_sentences.append(sent)

# 3. ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ max_sentences
cleaned_summary = '. '.join(unique_sentences[:max_sentences])
```

### Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ 4: Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ½ÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

**Regex Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹:**

```python
# Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ "1. ", "2. ", ...
cleaned = re.sub(r'^\d+\.\s*', '', cleaned, flags=re.MULTILINE)

# Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ "First post", "Second post", ...
cleaned = re.sub(r'^(In the )?(first|second|third|fourth|fifth)\s+post', '',
                 cleaned, flags=re.IGNORECASE | re.MULTILINE)

# Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ "The first post", "The second post", ...
cleaned = re.sub(r'^The (first|second|third|fourth|fifth)\s+post', '',
                 cleaned, flags=re.IGNORECASE | re.MULTILINE)
```

### Pipeline Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸

```
LLM Response
    â†“
_clean_json_from_summary()
    â†“ (remove JSON)
Remove numbering (re.sub)
    â†“
Remove Markdown (* _ ` [ ])
    â†“
Normalize quotes (" " â†’ ")
    â†“
Remove bullet points (â€¢ - *)
    â†“
Normalize whitespace
    â†“
Deduplicate sentences (>60% overlap)
    â†“
Limit to max_sentences
    â†“
clean_markdown() (final pass)
    â†“
Formatted text
```

---

## ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸

### Environment Variables

**Ğ¤Ğ°Ğ¹Ğ»:** `.env`

```bash
# LLM Configuration
SUMMARIZER_LANGUAGE=ru
SUMMARIZER_TEMPERATURE=0.5
SUMMARIZER_MAX_TOKENS=2000

# Digest Configuration
DIGEST_SUMMARY_SENTENCES=8
DIGEST_SUMMARY_MAX_CHARS=3900
DIGEST_MAX_CHANNELS=10

# Worker Configuration
MORNING_SUMMARY_TIME=09:00
EVENING_DIGEST_TIME=20:00
QUIET_HOURS_START=00:00
QUIET_HOURS_END=08:00

# Debug Mode
DEBUG_NOTIFICATION_INTERVAL_MINUTES=0  # 0 = disabled, >0 = debug mode
```

### Settings Model

**Ğ¤Ğ°Ğ¹Ğ»:** `src/infrastructure/config/settings.py`

```python
class Settings(BaseSettings):
    # Digest settings
    digest_summary_sentences: int = Field(
        default=8,
        description="Number of sentences per channel in digest"
    )
    digest_summary_max_chars: int = Field(
        default=3900,
        description="Maximum characters per channel summary (Telegram limit is 4096)"
    )
    digest_max_channels: int = Field(
        default=10,
        description="Maximum channels to include in digest"
    )

    # Summarizer settings
    summarizer_language: str = Field(
        default="ru",
        description="Language for summaries (ru/en)"
    )
    summarizer_temperature: float = Field(
        default=0.5,
        description="Temperature for summarization (higher = more creative)"
    )
    summarizer_max_tokens: int = Field(
        default=2000,
        description="Max tokens for summarization (more = longer summaries)"
    )

    # Worker settings
    morning_summary_time: str = "09:00"
    evening_digest_time: str = "20:00"
    quiet_hours_start: str = "00:00"
    quiet_hours_end: str = "08:00"
    debug_notification_interval_minutes: int = 0
```

### Adaptive max_sentences

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ² `channel_digest.py`:**

```python
base_sentences = settings.digest_summary_sentences  # 8
post_count = len(normalized_posts)

if post_count <= 5:
    max_sentences = base_sentences  # 8
elif post_count <= 15:
    max_sentences = min(base_sentences + 2, 12)  # 10-12
else:
    max_sentences = min(base_sentences + 4, 15)  # 12-15
```

**Rationale:**
- ĞœĞ°Ğ»Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² (1-5) â†’ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ summary (8 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹)
- Ğ¡Ñ€ĞµĞ´Ğ½Ğµ (6-15) â†’ Ñ‡ÑƒÑ‚ÑŒ Ğ´Ğ»Ğ¸Ğ½Ğ½ĞµĞµ (10-12)
- ĞœĞ½Ğ¾Ğ³Ğ¾ (16+) â†’ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ (12-15)

---

## ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ¸ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ´Ğ¾Ğ»Ğ³

### 1. ĞĞ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ Clean Architecture

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:**
- Presentation layer (`channel_digest.py`) Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Infrastructure (`summarize_posts()`)
- Application layer (`data_fetchers.py`) ÑĞ¼ĞµÑˆĞ°Ğ½ Ñ Presentation
- Domain Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° (Ğ´ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ, Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°) Ğ² Infrastructure

**Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ:**

```
Presentation â†’ Application (Use Cases) â†’ Infrastructure
```

**Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ:**

```
Presentation â†’ Infrastructure (Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ)
Application â†’ Infrastructure + Presentation (ÑĞ¼ĞµÑˆĞ°Ğ½Ğ¾)
```

### 2. Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ (>150 ÑÑ‚Ñ€Ğ¾Ğº)

| Ğ¤Ğ°Ğ¹Ğ» | Ğ¡Ñ‚Ñ€Ğ¾Ğº | ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° |
|------|-------|----------|
| `channel_digest.py` | 598 | Ğ¡Ğ¼ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ° ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ², ÑĞ±Ğ¾Ñ€Ğ° Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ², ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ |
| `summarizer.py` | 387 | ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ° + LLM + Map-Reduce |
| `summary_worker.py` | 259 | Scheduler + Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° + MCP + Telegram |

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸
- Ğ’Ñ‹Ğ½ĞµÑÑ‚Ğ¸ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ² use cases

### 3. Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:**

1. **ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Markdown:**
   - `clean_markdown()` Ğ² `formatters.py`
   - `_clean_json_from_summary()` Ğ² `summarizer.py`
   - Regex Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ² `summarize_posts()`

2. **Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ·Ğ°Ğ´Ğ°Ñ‡:**
   - `_compute_task_stats()` Ğ² `_summary_helpers.py`
   - ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµÑ‚ÑÑ Ğ² `_get_summary_from_db()` Ğ² `data_fetchers.py`

3. **Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ digest:**
   - `format_single_digest()` + `format_digest()`
   - Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒÑÑ‰Ğ°ÑÑÑ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸

### 4. Ğ¡Ğ¼ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸

**SummaryWorker:**
- âœ… Scheduling (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸)
- âœ… ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
- âŒ Ğ—Ğ½Ğ°ĞµÑ‚ Ğ¾ MCP client
- âŒ Ğ—Ğ½Ğ°ĞµÑ‚ Ğ¾ Telegram Bot API
- âŒ Ğ—Ğ½Ğ°ĞµÑ‚ Ğ¾ MongoDB (Ğ² debug Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ)

**Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ:**
- Worker â†’ Use Case â†’ Repository â†’ DB
- Worker â†’ Notification Service â†’ Telegram

**data_fetchers.py:**
- âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- âŒ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ² presentation)
- âŒ ĞŸÑ€ÑĞ¼Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ² DB (debug Ñ€ĞµĞ¶Ğ¸Ğ¼)

### 5. Ğ–Ñ‘ÑÑ‚ĞºĞ°Ñ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ Ñ MCP

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:**
- Worker Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ MCP server
- ĞĞµĞ»ÑŒĞ·Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±ĞµĞ· MCP
- Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ `SummarizerService`
- MCP tool ĞºĞ°Ğº Ğ¾Ğ´Ğ¸Ğ½ Ğ¸Ğ· Ğ°Ğ´Ğ°Ğ¿Ñ‚ĞµÑ€Ğ¾Ğ²

### 6. ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ use cases

**Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ:**
- Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ñ€Ğ°Ğ·Ğ¼Ğ°Ğ·Ğ°Ğ½Ğ° Ğ¿Ğ¾ presentation, application, infrastructure

**Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ:**

```python
# src/application/use_cases/get_task_summary.py
class GetTaskSummaryUseCase:
    def __init__(
        self,
        task_repository: TaskRepository,
        stats_calculator: TaskStatsCalculator
    ):
        self.task_repo = task_repository
        self.stats_calc = stats_calculator

    async def execute(
        self,
        user_id: int,
        timeframe: str
    ) -> TaskSummary:
        # Pure business logic
        ...

# src/application/use_cases/generate_channel_digest.py
class GenerateChannelDigestUseCase:
    def __init__(
        self,
        post_repository: PostRepository,
        summarizer: Summarizer
    ):
        self.post_repo = post_repository
        self.summarizer = summarizer

    async def execute(
        self,
        user_id: int,
        hours: int
    ) -> DigestMessage:
        # Pure business logic
        ...
```

### 7. ĞĞµÑ‚ Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸

**ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚ Ñ‚ĞµÑÑ‚Ñ‹:**
- âŒ Map-Reduce Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ (end-to-end)
- âŒ Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹
- âŒ Adaptive max_sentences
- âŒ Worker scheduling Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°

**Ğ•ÑÑ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹:**
- âœ… ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° JSON (`test_summarizer_cleaning.py`)
- âœ… Map-Reduce (Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ, `test_summarizer_map_reduce.py`)
- âœ… Summary helpers (`test_reminder_tools_summary_helpers.py`)

### 8. Hardcoded Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:**

```python
# summarizer.py
if cleaned and len(cleaned) > 20:  # Magic number
    cleaned_posts.append(cleaned[:500])  # Magic number

# channel_digest.py
if overlap > 0.6:  # Magic threshold
    is_duplicate = True

# formatters.py
if last_period > absolute_max * 0.7:  # Magic ratio
    return truncated[:last_period + 1]
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- Ğ’Ñ‹Ğ½ĞµÑÑ‚Ğ¸ Ğ² ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹ Ğ¸Ğ»Ğ¸ config

### 9. ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ Ğ»Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:**
- Hardcoded emoji Ğ¸ Ñ‚ĞµĞºÑÑ‚Ñ‹ Ğ² `formatters.py`
- ĞĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ·Ñ‹ĞºĞ¾Ğ² Ğ´Ğ»Ñ UI
- Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‚ ru/en

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- i18n ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°
- Ğ’Ñ‹Ğ½ĞµÑÑ‚Ğ¸ UI Ñ‚ĞµĞºÑÑ‚Ñ‹ Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

### 10. ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ retry Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ LLM

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:**

```python
for attempt in range(2):
    try:
        summary = await llm_client.generate(...)
        if summary and len(summary.strip()) > 10:
            return cleaned_summary
    except Exception as e:
        if attempt == 1:
            break
```

- Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ 2 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸
- ĞĞµÑ‚ exponential backoff
- ĞĞµÑ‚ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº (rate limit, timeout)

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `tenacity` Ğ´Ğ»Ñ retry
- Ğ Ğ°Ğ·Ğ½Ñ‹Ğµ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

---

## Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸

### Ğ“Ñ€Ğ°Ñ„ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        WORKERS LAYER                         â”‚
â”‚                                                              â”‚
â”‚  SummaryWorker â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â†’ Bot (aiogram)                  â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â”œâ”€â”€â”€â”€â”€â†’ MCPClient                       â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â””â”€â”€â”€â”€â”€â†’ data_fetchers                   â”‚
â”‚                              â†“                               â”‚
â”‚                              formatters                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PRESENTATION LAYER                       â”‚
â”‚                                                              â”‚
â”‚  MCP Tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â†’ TaskRepository                 â”‚
â”‚  - reminder_tools    â”‚                                       â”‚
â”‚  - channel_digest    â”œâ”€â”€â”€â”€â”€â†’ PostRepository                 â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â””â”€â”€â”€â”€â”€â†’ summarize_posts() âŒ WRONG!     â”‚
â”‚                              (should be use case)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  INFRASTRUCTURE LAYER                        â”‚
â”‚                                                              â”‚
â”‚  summarize_posts() â”€â”€â”¬â”€â”€â”€â”€â”€â†’ TokenCounter                   â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â”œâ”€â”€â”€â”€â”€â†’ MapReduceSummarizer            â”‚
â”‚                      â”‚       â†“                               â”‚
â”‚                      â”‚       SemanticChunker                 â”‚
â”‚                      â”‚       â†“                               â”‚
â”‚                      â”‚       LLMClient                       â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â””â”€â”€â”€â”€â”€â†’ ResilientLLMClient              â”‚
â”‚                                                              â”‚
â”‚  Repositories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ MongoDB                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       DOMAIN LAYER                           â”‚
â”‚                                                              â”‚
â”‚  TaskSummary, DigestItem, DigestMessage (pure models)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹

1. **Presentation â†’ Infrastructure (Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ):**
   - `channel_digest.py` â†’ `summarize_posts()`
   - Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ: Presentation â†’ Use Case â†’ Infrastructure

2. **Workers â†’ Presentation:**
   - `SummaryWorker` â†’ `data_fetchers.py`
   - `data_fetchers.py` â†’ `formatters.py` (ÑĞ¼ĞµÑˆĞµĞ½Ğ¸Ğµ application + presentation)

3. **Circular dependencies (Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾):**
   - `data_fetchers` Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ `formatters`
   - `formatters` Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ `settings`
   - Ğ Ğ¸ÑĞº Ñ†Ğ¸ĞºĞ»Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ñ€ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğµ

4. **God object:** `summarizer.py`
   - 387 ÑÑ‚Ñ€Ğ¾Ğº
   - ĞœĞ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ĞµĞ¹:
     - ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ°
     - LLM ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
     - Map-Reduce
     - Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
     - Fallback Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°

---

## Ğ ĞµĞ·ÑĞ¼Ğµ: ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ñ‹

### Ğ§Ñ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾ âœ…

1. **Map-Reduce Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**
   - Ğ­Ñ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ±Ğ¸ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ñ… Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²
   - Semantic chunking Ñ overlap
   - Parallel processing Ğ² Map Ñ„Ğ°Ğ·Ğµ

2. **Resilient LLM Client:**
   - Auto-fallback Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°Ğ¼Ğ¸
   - Retry Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°

3. **ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
   - ĞĞ³Ñ€ĞµÑÑĞ¸Ğ²Ğ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° JSON/Markdown
   - Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹
   - ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹

4. **Worker ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°:**
   - Scheduled notifications
   - Quiet hours
   - Debug mode

### Ğ§Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑƒĞ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ âŒ

1. **ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°:**
   - ĞĞ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ Clean Architecture (Presentation â†’ Infrastructure)
   - ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ use cases
   - Ğ¡Ğ¼ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸

2. **ĞšĞ¾Ğ´:**
   - Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ (>150 ÑÑ‚Ñ€Ğ¾Ğº)
   - Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸
   - Magic numbers

3. **Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
   - ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸
   - ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ integration Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Map-Reduce

4. **ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ:**
   - Hardcoded Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
   - ĞĞµÑ‚ Ğ»Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ UI

5. **Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸:**
   - Ğ–Ñ‘ÑÑ‚ĞºĞ°Ñ ÑĞ²ÑĞ·ÑŒ Ñ MCP
   - Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ

---

## ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²

**Map Phase (Russian):**

```
ĞŸĞµÑ€ĞµĞ´ Ñ‚Ğ¾Ğ±Ğ¾Ğ¹ Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² Ğ¸Ğ· Telegram-ĞºĞ°Ğ½Ğ°Ğ»Ğ°.

Ğ—ĞĞ”ĞĞ§Ğ: Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸ 5 ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ñ„Ğ°ĞºÑ‚Ğ¾Ğ² Ğ¸Ğ· ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚Ğ°. ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ„Ğ°ĞºÑ‚ â€” Ğ¾Ğ´Ğ½Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ.
Ğ¤Ğ°ĞºÑ‚Ñ‹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ Ğ ĞĞ—ĞĞ«ĞœĞ˜ Ğ¿Ğ¾ ÑĞ¼Ñ‹ÑĞ»Ñƒ. ĞĞ¸ĞºĞ°ĞºĞ¸Ñ… Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ². Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚, Ğ±ĞµĞ· Ğ½ÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Markdown.

Ğ’ĞĞ–ĞĞ: Ğ’ĞµÑ€Ğ½Ğ¸ Ğ¢ĞĞ›Ğ¬ĞšĞ Ñ‚ĞµĞºÑÑ‚, ĞĞ• JSON, ĞĞ• ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ. Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ Ñ‡ĞµÑ€ĞµĞ· Ñ‚Ğ¾Ñ‡ĞºÑƒ.

Ğ¤Ğ ĞĞ“ĞœĞ•ĞĞ¢:
1. OpenAI Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ° GPT-4 Turbo Ñ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ½Ñ‹Ğ¼ Ğ¾ĞºĞ½Ğ¾Ğ¼ Ğ´Ğ¾ 128K Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ².
2. ĞĞ¾Ğ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¸ JSON Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¸Ğ· ĞºĞ¾Ñ€Ğ¾Ğ±ĞºĞ¸.
3. Ğ¦ĞµĞ½Ğ° ÑĞ½Ğ¸Ğ¶ĞµĞ½Ğ° Ğ½Ğ° 50% Ğ¿Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ Ñ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸ĞµĞ¹.
...

ĞšĞ›Ğ®Ğ§Ğ•Ğ’Ğ«Ğ• Ğ¤ĞĞšĞ¢Ğ«:
```

**Reduce Phase (Russian):**

```
ĞŸĞµÑ€ĞµĞ´ Ñ‚Ğ¾Ğ±Ğ¾Ğ¹ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¹ Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Telegram-ĞºĞ°Ğ½Ğ°Ğ»Ğ°.

Ğ—ĞĞ”ĞĞ§Ğ: ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½Ğ¸ Ğ¸Ñ… Ğ² 8 Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹, Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ÑÑ‰Ğ¸Ñ… Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğµ Ñ‚ĞµĞ¼Ñ‹ ĞºĞ°Ğ½Ğ°Ğ»Ğ°.
Ğ˜Ğ·Ğ±ĞµĞ³Ğ°Ğ¹ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ². ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¿ÑƒĞ½ĞºÑ‚ â€” ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¼Ñ‹ÑĞ»ÑŒ. Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚ĞµĞºÑÑ‚, Ğ±ĞµĞ· Ğ½ÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Markdown.

Ğ’ĞĞ–ĞĞ: Ğ’ĞµÑ€Ğ½Ğ¸ Ğ¢ĞĞ›Ğ¬ĞšĞ Ñ‚ĞµĞºÑÑ‚, ĞĞ• JSON, ĞĞ• ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ. Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ Ñ‡ĞµÑ€ĞµĞ· Ñ‚Ğ¾Ñ‡ĞºÑƒ.

Ğ¡Ğ£ĞœĞœĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜ Ğ¤Ğ ĞĞ“ĞœĞ•ĞĞ¢ĞĞ’:
Fragment 1:
OpenAI Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ° GPT-4 Turbo Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ½Ñ‹Ğ¼ Ğ¾ĞºĞ½Ğ¾Ğ¼ 128K. ĞĞ¾Ğ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ JSON Ñ€ĞµĞ¶Ğ¸Ğ¼. Ğ¦ĞµĞ½Ğ° ÑĞ½Ğ¸Ğ¶ĞµĞ½Ğ° Ğ½Ğ° 50%.

Fragment 2:
Microsoft Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ» GPT-4 Ğ² Copilot Ğ´Ğ»Ñ Office. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº AI Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ñƒ. Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ğ² Word, Excel, PowerPoint.

Ğ˜Ğ¢ĞĞ“ĞĞ’ĞĞ¯ Ğ¡Ğ£ĞœĞœĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯:
```

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸

**Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ:**

| ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ° | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------|----------|
| Map phase duration | 2-5 ÑĞµĞºÑƒĞ½Ğ´ | Ğ’Ñ€ĞµĞ¼Ñ Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ chunk |
| Reduce phase duration | 3-6 ÑĞµĞºÑƒĞ½Ğ´ | Ğ’Ñ€ĞµĞ¼Ñ Ğ½Ğ° Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ |
| Total (Map-Reduce) | 8-15 ÑĞµĞºÑƒĞ½Ğ´ | ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ 2 chunks |
| Direct summarization | 3-7 ÑĞµĞºÑƒĞ½Ğ´ | ĞŸÑ€ÑĞ¼Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (< 3000 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²) |
| Chunks processed | 2-5 | Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ chunks |
| Token count | 4000-8000 | Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ² Ğ¿Ğ¾ÑÑ‚Ğ°Ñ… |

---

**Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ»ĞµĞ½:** 2025-11-04
**Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑˆĞ°Ğ³:** Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
