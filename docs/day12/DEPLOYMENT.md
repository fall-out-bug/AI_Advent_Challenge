# Day 12 - Deployment Guide

**Date**: Phase 8 Implementation  
**Status**: âœ… Ready for Deployment  
**Approach**: Docker Compose with monitoring

## Overview

This guide covers deployment of Day 12 features including the post fetcher worker, PDF digest generation, and Prometheus metrics monitoring.

## Prerequisites

- Docker Engine 20.10+ and Docker Compose 2.0+
- MongoDB 6.0+ (or use included MongoDB service)
- Telegram Bot Token (from @BotFather)
- Telegram API credentials (API ID, API Hash)
- NVIDIA GPU (optional, for LLM inference)

## Environment Variables

Create a `.env` file in the project root with the following variables:

```bash
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash
TELEGRAM_SESSION_STRING=your_session_string  # Generated by init_pyrogram.py

# HuggingFace Token (for LLM models)
HF_TOKEN=your_hf_token_here

# MongoDB Configuration
MONGODB_URL=mongodb://mongodb:27017
DB_NAME=butler

# LLM Configuration
LLM_URL=http://mistral-chat:8000

# Post Fetcher Worker Configuration
POST_FETCH_INTERVAL_HOURS=1  # Default: 1 hour
POST_TTL_DAYS=7  # Default: 7 days

# Summary Worker Configuration
MORNING_SUMMARY_TIME=09:00
EVENING_DIGEST_TIME=20:00
QUIET_HOURS_START=22
QUIET_HOURS_END=8
DEBUG_NOTIFICATION_INTERVAL_MINUTES=0

# Logging
LOG_LEVEL=INFO
PYTHONUNBUFFERED=1
```

## Docker Compose Deployment

### 1. Build Images

```bash
docker-compose -f docker-compose.day12.yml build
```

### 2. Start Services

```bash
docker-compose -f docker-compose.day12.yml up -d
```

### 3. Check Service Status

```bash
docker-compose -f docker-compose.day12.yml ps
```

### 4. View Logs

```bash
# All services
docker-compose -f docker-compose.day12.yml logs -f

# Specific service
docker-compose -f docker-compose.day12.yml logs -f post-fetcher-worker
docker-compose -f docker-compose.day12.yml logs -f mcp-server
docker-compose -f docker-compose.day12.yml logs -f telegram-bot
```

### 5. Stop Services

```bash
docker-compose -f docker-compose.day12.yml down
```

### 6. Stop and Remove Volumes

```bash
docker-compose -f docker-compose.day12.yml down -v
```

## Service Details

### Services Overview

1. **mistral-chat**: LLM inference server (port 8001)
2. **mongodb**: MongoDB database (port 27017)
3. **mcp-server**: MCP server with PDF tools (port 8004)
4. **telegram-bot**: Telegram bot handler
5. **summary-worker**: Scheduled summary/digest worker
6. **post-fetcher-worker**: Hourly post collection worker (NEW)

### Post Fetcher Worker

**Purpose**: Collects posts from subscribed Telegram channels hourly and saves them to MongoDB.

**Configuration**:
- `POST_FETCH_INTERVAL_HOURS`: Interval between runs (default: 1 hour)
- `POST_TTL_DAYS`: Post retention period (default: 7 days)

**Health Check**: Process-level check (Python process running)

**Resource Limits**:
- CPU: 0.25 cores
- Memory: 128MB

### MCP Server

**Endpoints**:
- `GET /health`: Health check
- `GET /tools`: List available tools
- `POST /call`: Call an MCP tool
- `GET /metrics`: Prometheus metrics (NEW)

**Metrics Endpoint**: `http://localhost:8004/metrics`

## Monitoring Setup

### Prometheus Configuration

1. **Install Prometheus**:

```bash
# Download Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
tar xvfz prometheus-2.45.0.linux-amd64.tar.gz
cd prometheus-2.45.0.linux-amd64
```

2. **Configure Prometheus** (`prometheus.yml`):

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'mcp-server'
    static_configs:
      - targets: ['localhost:8004']
    metrics_path: '/metrics'

  - job_name: 'post-fetcher-worker'
    static_configs:
      - targets: ['localhost:8004']  # Metrics exposed via MCP server
```

3. **Start Prometheus**:

```bash
./prometheus --config.file=prometheus.yml
```

4. **Configure Alerts**:

Add alert rules from `prometheus/alerts.yml` to Prometheus configuration:

```yaml
rule_files:
  - "prometheus/alerts.yml"
```

### Available Metrics

#### Post Fetcher Worker Metrics

- `post_fetcher_posts_saved_total`: Total posts saved (by channel)
- `post_fetcher_channels_processed_total`: Total channels processed
- `post_fetcher_errors_total`: Total errors (by error type)
- `post_fetcher_duration_seconds`: Processing duration histogram
- `post_fetcher_posts_skipped_total`: Total posts skipped (duplicates)
- `post_fetcher_worker_running`: Worker running status (1 = running, 0 = stopped)
- `post_fetcher_last_run_timestamp_seconds`: Unix timestamp of last run

#### PDF Generation Metrics

- `pdf_generation_duration_seconds`: PDF generation duration histogram
- `pdf_generation_errors_total`: Total PDF generation errors (by error type)
- `pdf_file_size_bytes`: Generated PDF file sizes histogram
- `pdf_pages_total`: Number of pages in PDFs histogram

#### Bot Digest Handler Metrics

- `bot_digest_requests_total`: Total digest requests
- `bot_digest_cache_hits_total`: Total cache hits
- `bot_digest_errors_total`: Total errors (by error type)

### Alert Rules

See `prometheus/alerts.yml` for configured alerts:

1. **PostFetcherWorkerDown**: Worker not running for > 2 minutes (critical)
2. **PostFetcherHighErrorRate**: > 3 errors in 1 hour (critical)
3. **PostFetcherNoRuns**: No runs in last 2 hours (warning)
4. **PDFGenerationHighErrorRate**: > 10% error rate in 5 minutes (warning)
5. **PDFGenerationHighLatency**: P95 latency > 30 seconds (warning)
6. **BotDigestHighErrorRate**: > 10% error rate in 5 minutes (warning)
7. **BotDigestLowCacheHitRate**: < 30% cache hit rate (info)
8. **PostFetcherSlowProcessing**: P95 processing time > 2 minutes (warning)

## Scaling Considerations

### Horizontal Scaling

- **Post Fetcher Worker**: Can run multiple instances, but ensure MongoDB indexes are optimized
- **MCP Server**: Can scale horizontally behind load balancer
- **Telegram Bot**: Single instance (Telegram API limitation)

### Vertical Scaling

- **Post Fetcher Worker**: Increase CPU/memory if processing many channels
- **MCP Server**: Increase memory for concurrent PDF generation
- **MongoDB**: Increase memory for larger post collections

### Database Optimization

Ensure MongoDB indexes are created:

```javascript
// In MongoDB shell
use butler

// Posts collection indexes
db.posts.createIndex({ "channel_username": 1, "message_id": 1 })
db.posts.createIndex({ "content_hash": 1, "date": 1 })
db.posts.createIndex({ "user_id": 1, "date": 1 })
db.posts.createIndex({ "date": 1 }, { expireAfterSeconds: 604800 })  // 7 days TTL

// Channels collection indexes
db.channels.createIndex({ "active": 1 })
db.channels.createIndex({ "user_id": 1, "active": 1 })
```

## Troubleshooting

### Post Fetcher Worker Not Starting

1. Check logs: `docker-compose -f docker-compose.day12.yml logs post-fetcher-worker`
2. Verify MongoDB connection: Check `MONGODB_URL` environment variable
3. Verify MCP server is running: Check `MCP_SERVER_URL` is accessible
4. Check Telegram credentials: Ensure `TELEGRAM_API_ID`, `TELEGRAM_API_HASH`, `TELEGRAM_SESSION_STRING` are set

### PDF Generation Failing

1. Check MCP server logs: `docker-compose -f docker-compose.day12.yml logs mcp-server`
2. Verify weasyprint is installed: Check worker Dockerfile includes weasyprint
3. Check available memory: PDF generation requires sufficient memory
4. Review metrics: Check `pdf_generation_errors_total` metric for error types

### High Error Rates

1. Check Prometheus alerts: Review alert history
2. Check logs: Review service logs for error patterns
3. Check resource limits: Ensure services have sufficient CPU/memory
4. Check MongoDB: Verify database connectivity and performance

### Metrics Not Available

1. Verify Prometheus client is installed: Check `pyproject.toml` includes `prometheus-client`
2. Check MCP server metrics endpoint: `curl http://localhost:8004/metrics`
3. Check Prometheus configuration: Verify scrape configs are correct
4. Check logs: Review MCP server logs for import errors

## Production Checklist

- [ ] Environment variables configured in `.env`
- [ ] MongoDB indexes created
- [ ] Prometheus configured with alert rules
- [ ] Health checks verified for all services
- [ ] Resource limits appropriate for workload
- [ ] Log aggregation configured (optional)
- [ ] Backup strategy for MongoDB (optional)
- [ ] Monitoring dashboards configured (optional)
- [ ] Alert notifications configured (Slack/Email/PagerDuty)

## Performance Tuning

### Post Fetcher Worker

- **Concurrent Processing**: Consider processing channels in parallel (modify worker code)
- **Batch Size**: Adjust MongoDB query batch size for large channel lists
- **Interval**: Adjust `POST_FETCH_INTERVAL_HOURS` based on update frequency needs

### PDF Generation

- **Caching**: PDF cache TTL is 1 hour (configurable via `PDF_CACHE_TTL_HOURS`)
- **Memory**: Increase memory limit if generating large PDFs
- **Concurrency**: Limit concurrent PDF generations to avoid memory issues

### MongoDB

- **Connection Pool**: Configure MongoDB connection pool size
- **Indexes**: Ensure all required indexes are created
- **TTL**: Post TTL is 7 days (configurable via `POST_TTL_DAYS`)

## Security Considerations

1. **Secrets Management**: Use Docker secrets or external secret manager for sensitive data
2. **Network Isolation**: Services run in isolated Docker network
3. **Resource Limits**: All services have CPU/memory limits
4. **Health Checks**: All services have health checks configured
5. **Logging**: Structured logging with appropriate log levels

## Support

For issues or questions:
- Check logs: `docker-compose -f docker-compose.day12.yml logs`
- Review metrics: `http://localhost:8004/metrics`
- Check Prometheus alerts: Review alert history
- Review documentation: See `docs/day12/` for API and architecture docs

