# Agent Interaction Protocol v2.0
# Token-optimized structured communication

protocol_version: 2.0
optimization: max_compression

# Message Format (all agent communications)
message_schema:
  header:
    id: uuid
    from: agent_role
    to: agent_role|broadcast
    epic_id: str
    iteration: int
    timestamp: iso8601

  body:
    action: code  # 3-letter codes
    data: json|yaml  # Compressed payload
    priority: P0|P1|P2

  response:
    status: ACK|REJ|VTO|ESC  # Acknowledge/Reject/Veto/Escalate
    reason: code  # Standardized reason codes
    fix: action_code  # Required action

# Action Codes (3-letter for compression)
action_codes:
  # Analyst
  REQ: define_requirements
  ACC: acceptance_criteria
  ROI: roi_validation

  # Architect
  ARC: architecture_design
  BND: boundary_definition
  CTR: contract_specification

  # Tech Lead
  PLN: implementation_plan
  STG: staging_definition
  TST: test_strategy

  # Developer
  IMP: implementation_complete
  BLK: blocked_on_input
  DVN: deviation_from_plan

  # Quality
  RVW: review_complete
  ISS: issues_found
  APR: approval_granted

  # DevOps
  DPL: deployment_ready
  HLT: health_check_status
  RLB: rollback_executed

# Reason Codes (why rejected/vetoed)
reason_codes:
  # Architecture
  LYR: layer_violation
  CRC: circular_dependency
  BND: boundary_violation

  # Requirements
  TST: not_testable
  VAL: no_value
  SCP: scope_creep

  # Implementation
  CVG: low_coverage
  CMP: high_complexity
  SEC: security_issue

  # Operations
  HLT: health_check_failed
  MNT: not_monitorable
  RLB: no_rollback_plan

# Communication Matrix (who talks to whom)
communication_flows:
  epic_start:
    sequence:
      - {from: analyst, to: broadcast, action: REQ}
      - {from: architect, to: analyst, action: ARC}
      - {from: tech_lead, to: [analyst, architect], action: PLN}

  implementation:
    sequence:
      - {from: tech_lead, to: developer, action: PLN}
      - {from: developer, to: tech_lead, action: IMP|BLK}
      - {from: quality, to: developer, action: RVW}

  deployment:
    sequence:
      - {from: quality, to: devops, action: APR}
      - {from: devops, to: broadcast, action: DPL}
      - {from: devops, to: tech_lead, action: HLT}

# Veto Rules (absolute powers by domain)
veto_matrix:
  analyst:
    can_veto: [scope_expansion, unclear_requirements, no_roi]
    vetoed_by: none

  architect:
    can_veto: [layer_violations, circular_dependencies, boundary_breaks]
    vetoed_by: none

  tech_lead:
    can_veto: [untestable_tasks, impossible_staging, no_rollback]
    vetoed_by: [analyst, architect]

  quality:
    can_veto: [critical_issues, architecture_violations, low_coverage]
    vetoed_by: none

  devops:
    can_veto: [no_monitoring, no_health_checks, untested_deployment]
    vetoed_by: none

# Consensus Rules
consensus:
  max_iterations: 3

  escalation_triggers:
    - iterations > 3
    - veto_conflict: true
    - deadlock: true

  resolution_priority:
    1: safety  # Production stability
    2: architecture  # Clean boundaries
    3: value  # Business value
    4: speed  # Delivery velocity

  voting_weights:
    by_domain:
      requirements: {analyst: 0.6, architect: 0.2, tech_lead: 0.2}
      architecture: {architect: 0.6, analyst: 0.2, tech_lead: 0.2}
      implementation: {tech_lead: 0.4, developer: 0.3, quality: 0.3}
      deployment: {devops: 0.5, quality: 0.3, tech_lead: 0.2}

# State Management
shared_state:
  epic_context:
    format: json
    max_size_kb: 10
    fields: [epic_id, requirements, architecture, plan, status]

  decision_log:
    format: jsonl  # Line-delimited for append
    retention: current_epic_only
    fields: [timestamp, agent, decision, reason]

  metrics_cache:
    format: yaml
    update_frequency: per_iteration
    fields: [coverage, complexity, violations]

# Compression Strategies
compression:
  techniques:
    - use_codes_not_strings
    - reference_by_id_only
    - delta_updates_only
    - compress_json_keys

  prohibited:
    - natural_language_between_agents
    - redundant_information
    - historical_context_beyond_epic

# Human Interface
human_escalation:
  format: markdown  # Only for human communication

  summary_template: |
    ## Consensus Failure - Epic {{epic_id}}
    **Iteration:** {{iteration}}/3
    **Conflict:** {{conflict_type}}

    ### Positions
    {{#each positions}}
    - **{{agent}}**: {{stance}} ({{reason_code}})
    {{/each}}

    ### Options
    1. {{option_1}}
    2. {{option_2}}
    3. {{option_3}}

    **Recommendation:** {{weighted_recommendation}}

  decision_required:
    - override_veto: which_agent
    - choose_path: option_number
    - modify_requirement: new_text
    - defer_to_next_epic: bool
